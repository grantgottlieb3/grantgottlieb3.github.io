<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>$imple Budget Sheet</title>

  <script>
    (function () {
      const VERSION = '2025-09-25-4';
      const STORAGE_KEY = 'app_version';
      try {
        const prev = localStorage.getItem(STORAGE_KEY);
        if (prev && prev !== VERSION) { localStorage.setItem(STORAGE_KEY, VERSION); location.reload(); }
        else if (!prev) { localStorage.setItem(STORAGE_KEY, VERSION); }
        window.APP_VERSION = VERSION;
      } catch {}
    })();
  </script>

  <link rel="stylesheet" href="styles.css" />
  <link rel="apple-touch-icon" href="icon.png" />

  <style>
    :root{
      --pad:16px;
      --text:#111;
      --bg:#fff;
      --good:#0a7a30;
      --bad:#b00020;
    }
    body{ margin:0; color:var(--text); background:var(--bg); }
    input, select, textarea, button { font-size:16px; color:var(--text); }
    .container{ max-width:960px; margin:0 auto; padding:0 12px; }
    .header{ position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:color-mix(in oklab, white 80%, transparent); border-bottom:1px solid var(--border, #e5e5e5); z-index:10; }
    .nav{ display:flex; align-items:center; padding:8px 0; }
    .view-tabs{ display:flex; gap:8px; justify-content:center; width:100%; }
    .tab-btn[aria-selected="true"]{ border-color: var(--accent, #36c); color: var(--accent, #36c); }
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .section-title h2{ margin:0; font-size:18px; }
    .line{ height:1px; background:var(--border, #e5e5e5); flex:1; }
    .grid{ display:grid; gap:8px; }
    .cols-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .card{ background:var(--card, #fff); border:1px solid var(--border, #e5e5e5); border-radius:12px; padding:var(--pad); }
    .item{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:8px 0; }
    .badge{ display:inline-block; padding:4px 8px; border:1px dashed var(--border, #ddd); border-radius:999px; font-size:12px; color:var(--text); }
    .button{ cursor:pointer; border:1px solid var(--border, #e5e5e5); background:transparent; border-radius:12px; padding:8px 12px; }
    .button.ghost{ background:transparent; }
    .button.secondary{ background:var(--accent-2, #eef4ff); border-color:var(--accent, #36c); }
    .meta{ color:var(--muted, #666); font-size:12px; }
    .brand{ display:none; }

    /* bins editor row */
    .bin-row{ display:grid; grid-template-columns:minmax(0,1fr) 140px auto; gap:8px; align-items:center; }
    .bin-actions{ display:flex; gap:6px; }

    /* compact input shell */
    .fld{ width:100%; padding:12px; border:1px solid var(--border, #e5e5e5); border-radius:12px; background:var(--card, #fff); color:var(--text); min-width:0; }

    /* expense list padding fix */
    .card.item{ padding:16px; }
    .card.item h3{ margin:0 0 4px; }

    /* responsive helpers */
    @media (max-width: 900px){
      .cols-3{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 540px){
      .cols-2, .cols-3{ grid-template-columns: 1fr; }
      .bin-row{ grid-template-columns: 1fr; }
      .section-title{ flex-direction:column; align-items:flex-start; }
    }

    /* profile layout tuning for narrow phones */
    .profile-grid{ display:grid; grid-template-columns: repeat(3, minmax(140px,1fr)); gap:8px; }
    .profile-grid .span-2{ grid-column: span 2; }
    .profile-actions{ display:flex; align-items:flex-end; gap:8px; }
    @media (max-width: 420px){
      .profile-grid{ grid-template-columns: 1fr; }
      .profile-grid .span-2{ grid-column:auto; }
      .profile-actions{ flex-wrap:wrap; }
    }

    /* chart */
    #overviewChart { width:100%; height:240px; display:block; }
    .stat-val{ font-size:20px; font-weight:700; }
    .stat-good{ color:var(--good); }
    .stat-bad{ color:var(--bad); }
  </style>
</head>

<body>
  <header class="header">
    <div class="container nav">
      <nav class="view-tabs" role="tablist" aria-label="Primary">
        <button id="tab-budget" class="button ghost tab-btn" aria-selected="true" onclick="UI.switchTab('budget')">Budget</button>
        <button id="tab-overview" class="button ghost tab-btn" aria-selected="false" onclick="UI.switchTab('overview')">Overview</button>
        <button id="tab-profile" class="button ghost tab-btn" aria-selected="false" onclick="UI.switchTab('profile')">Profile</button>
      </nav>
    </div>
  </header>

  <main class="container" id="app" style="padding-bottom:32px;">

    <!-- BUDGET -->
    <section id="view-budget" role="tabpanel" aria-labelledby="tab-budget">
      <div class="section-title" style="margin-top:8px;">
        <h2>Monthly Budget</h2><div class="line"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="button ghost" title="Prev month" onclick="Budget.shiftMonth(-1)">◀</button>
          <span class="badge" id="monthLabel">—</span>
          <button class="button ghost" title="Next month" onclick="Budget.shiftMonth(1)">▶</button>
        </div>
      </div>

      <div class="grid cols-3" id="binsSummary"></div>

      <section class="card" style="margin-top:16px;">
        <div class="section-title" style="margin:0 0 8px;">
          <h2>Expenses</h2><div class="line"></div>
        </div>
        <div id="expenseList" class="grid"></div>
        <p id="noExpenses" class="badge" style="margin-top:8px; display:none;">No expenses yet this month.</p>
      </section>
    </section>

    <!-- OVERVIEW -->
    <section id="view-overview" role="tabpanel" aria-labelledby="tab-overview" hidden>
      <div class="section-title" style="margin-top:8px;">
        <h2>Overview</h2><div class="line"></div>
              </div>
    
       <!-- Graph first -->
      <section class="card">
              <div class="section-title" style="margin:0 0 8px;">
              <h2>Income vs Spent</h2><div class="line"></div>
            </div>
            <canvas id="overviewChart"></canvas>
            <p id="chartNote" class="meta" style="margin-top:8px;"></p>
          </section>
    
          <!-- Summary: This month + overall -->
          <section class="card" style="margin-top:16px;">
            <div class="section-title" style="margin:0 0 8px;">
              <h2>Summary</h2><div class="line"></div>
            </div>
            <div id="overallStats" class="grid cols-3"></div>
            <p id="overviewNote" class="meta" style="margin-top:8px;"></p>
          </section>
        </section>
    
    <!-- PROFILE -->
    <section id="view-profile" role="tabpanel" aria-labelledby="tab-profile" hidden>
      <div class="section-title">
        <h2>Profile</h2><div class="line"></div>
      </div>

      <section class="card">
        <div class="profile-grid">
          <div class="span-2">
            <label class="badge" for="stipend">Monthly Income</label>
            <div class="grid" style="grid-template-columns: 1fr 120px;">
              <input id="stipend" type="number" inputmode="decimal" step="0.01" placeholder="1000" class="fld" />
              <select id="stipendCur" class="fld">
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
              </select>
            </div>
          </div>
          <div>
            <label class="badge" for="currency">Display currency</label>
            <select id="currency" class="fld">
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
            </select>
          </div>
          <div>
            <label class="badge" for="fx">EUR → USD rate</label>
            <input id="fx" type="number" inputmode="decimal" step="0.0001" placeholder="1.08" class="fld" />
          </div>
          <div>
            <label class="badge" for="startMonth">Starting month</label>
            <input id="startMonth" type="month" class="fld" />
          </div>
          <div class="profile-actions">
            <button class="button ghost" onclick="Profile.save()">Save</button>
            <button class="button ghost" onclick="App.resetAll()">Reset All</button>
            <span id="saveNote" class="badge" style="border-style:dashed;"> </span>
          </div>
        </div>
      </section>

      <div class="section-title" style="margin-top:16px;">
        <h2>Budget Bins</h2><div class="line"></div>
      </div>

      <section class="card">
        <div id="binList" class="grid" style="gap:12px;"></div>

        <div class="grid" style="margin-top:16px; grid-template-columns: 1fr 1fr auto;">
          <input id="newBinName" type="text" placeholder="New bin (e.g., Rent)" class="fld" />
          <input id="newBinAmt" type="number" inputmode="decimal" step="0.01" placeholder="Amount / month" class="fld" />
          <button class="button ghost" style="padding:12px 18px;" onclick="Profile.addBin()">Add</button>
        </div>
      </section>
    </section>
  </main>

  <dialog id="addDialog" style="border:none; border-radius:16px; max-width:560px; width:92vw; padding:0;">
    <form method="dialog" class="card" style="margin:0;">
      <div class="section-title" style="margin:0 0 8px;">
        <h2 id="dlgTitle">Add Expense</h2><div class="line"></div>
        <button class="button ghost" value="cancel">Close</button>
      </div>
      <div class="grid cols-2">
        <div>
          <label class="badge">Name</label>
          <input id="dlgName" type="text" placeholder="e.g., Groceries" class="fld" />
        </div>
        <div>
          <label class="badge">Amount (<span id="dlgCur">$</span>)</label>
          <input id="dlgAmt" type="number" inputmode="decimal" step="0.01" placeholder="0.00" class="fld" />
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="button ghost" onclick="Budget.saveDialog(event)">Save</button>
        <button class="button ghost" value="cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <script>
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const App = {
      key: 'budget_key', <!-- DO NOT CHANGE THE KEY -->
      state: null,
      defaultState(){
        const ym = Util.fmtYM(new Date());
        const defaultFX = 1.08;
        const defaultStipendUSD = 1000;
        return {
          settings: {
            stipendEUR: defaultStipendUSD / defaultFX,
            stipendInputCurrency: 'USD',
            currency: 'USD',
            fx: defaultFX,
            startMonth: ym
          },
          bins: [
            { id: Util.id(), name: 'Rent',       monthlyEUR: 500 },
            { id: Util.id(), name: 'Groceries',  monthlyEUR: 200 },
            { id: Util.id(), name: 'Transport',  monthlyEUR: 80  },
          ],
          expenses: {}
        };
      },
      load(){
        try {
          const raw = localStorage.getItem(this.key);
          this.state = raw ? JSON.parse(raw) : this.defaultState();
        } catch { this.state = this.defaultState(); }
      },
      save(){ localStorage.setItem(this.key, JSON.stringify(this.state)); },
      resetAll(){
        if(!confirm('Reset all data?')) return;
        localStorage.removeItem(this.key);
        location.reload();
      }
    };

    const Util = {
      id: () => Math.random().toString(36).slice(2,9),
      fmtYM: (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,
      labelYM(ym){ const [y,m]=ym.split('-').map(Number); return new Date(y, m-1, 1).toLocaleString(undefined,{month:'long', year:'numeric'}); },
      ensureMonth(ym){ const S=App.state; if(!S.expenses[ym]) S.expenses[ym]=[]; },
      eurToDisp(eur){ const {currency,fx} = App.state.settings; return currency==='EUR'? eur : eur*fx; },
      dispToEur(n){ const {currency,fx} = App.state.settings; return currency==='EUR'? n : n/fx; },
      eurToStipendDisp(eur){ const {stipendInputCurrency, fx} = App.state.settings; return stipendInputCurrency==='EUR' ? eur : eur*fx; },
      stipendDispToEur(n){ const {stipendInputCurrency, fx} = App.state.settings; return stipendInputCurrency==='EUR' ? n : n/(fx||1); },
      money(n){
        const cur = App.state.settings.currency==='EUR' ? 'EUR' : 'USD';
        return new Intl.NumberFormat(undefined,{style:'currency',currency:cur, maximumFractionDigits:2}).format(n);
      },
      sortYM(a,b){ return a.localeCompare(b); }
    };

    const UI = {
      currentYM: null,
      switchTab(name){
        const views = {budget: '#view-budget', overview: '#view-overview', profile: '#view-profile'};
        const tabs  = {budget: '#tab-budget', overview: '#tab-overview', profile: '#tab-profile'};
        Object.keys(views).forEach(k => $(views[k]).hidden = (k!==name));
        Object.keys(tabs).forEach(k => $(tabs[k]).setAttribute('aria-selected', String(k===name)));
        if(name==='budget') Budget.render();
        else if(name==='overview') Overview.render();
        else Profile.render();
      }
    };

    const Overview = {
      render(){
        this.renderChart();
        this.renderStats();
      },
      activeMonths(){
        return Object.keys(App.state.expenses)
          .filter(ym => (App.state.expenses[ym] || []).length > 0)
          .sort(Util.sortYM);
      },
      renderStats(){
        const host = $('#overallStats'); 
        host.innerHTML = '';

        const S = App.state;
        const stipendPerMonthEUR = S.settings.stipendEUR || 0;

        // current month (the "starting" month in focus)
        const currentYM = UI.currentYM || S.settings.startMonth || Util.fmtYM(new Date());
        Util.ensureMonth(currentYM);
        const monthExpenses = S.expenses[currentYM] || [];
        let monthSpentEUR = 0;
        monthExpenses.forEach(e => monthSpentEUR += e.amountEUR);
        const monthIncomeEUR = stipendPerMonthEUR;
        const monthNetEUR = monthIncomeEUR - monthSpentEUR;

        // overall
        let totalSpentEUR = 0;
        Object.values(S.expenses).forEach(list => list.forEach(e => totalSpentEUR += e.amountEUR));
        const months = this.activeMonths();
        const totalMonths = months.length;
        const totalIncomeEUR = totalMonths * stipendPerMonthEUR;
        const netEUR = totalIncomeEUR - totalSpentEUR;

        const makeStat = (label, val, scope, cls='') => `
          <div class="card">
            <div class="meta">${scope}</div>
            <div class="stat-val ${cls}">${val}</div>
            <div class="meta">${label}</div>
          </div>`;

        const monthNetClass = monthNetEUR >= 0 ? 'stat-good' : 'stat-bad';
        const netClass      = netEUR      >= 0 ? 'stat-good' : 'stat-bad';

        const monthLabel = Util.labelYM(currentYM);

        const monthNetDisp   = Util.money(Util.eurToDisp(monthNetEUR));
        const monthIncDisp   = Util.money(Util.eurToDisp(monthIncomeEUR));
        const monthSpentDisp = Util.money(Util.eurToDisp(monthSpentEUR));

        const totalNetDisp   = Util.money(Util.eurToDisp(netEUR));
        const totalIncDisp   = Util.money(Util.eurToDisp(totalIncomeEUR));
        const totalSpentDisp = Util.money(Util.eurToDisp(totalSpentEUR));

        host.innerHTML = [
          // this month
          makeStat('Net',   monthNetDisp,   monthLabel, monthNetClass),
          makeStat('Earned',monthIncDisp,   monthLabel),
          makeStat('Spent', monthSpentDisp, monthLabel),

          // overall (based on months with any expenses)
          makeStat('Net',   totalNetDisp,   'All months', netClass),
          makeStat('Earned',totalIncDisp,   'All months'),
          makeStat('Spent', totalSpentDisp, 'All months')
        ].join('');

        const note = $('#overviewNote');
        if(note){
          if(!months.length && !monthExpenses.length){
            note.textContent = 'No expenses recorded yet. Add some in the Budget tab to start tracking.';
          }else{
            note.textContent =
              `Current month (${monthLabel}): earned ${monthIncDisp}, spent ${monthSpentDisp}, net ${monthNetDisp}.`;
          }
        }
      },
      renderChart(){
        const c = $('#overviewChart');
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        const Wcss = Math.max(300, rect.width || 300);
        const Hcss = Math.max(200, rect.height || 200);

        c.width  = Wcss * dpr;
        c.height = Hcss * dpr;

        const ctx = c.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const W = Wcss;
        const H = Hcss;

        ctx.clearRect(0, 0, W, H);

        const cs = getComputedStyle(document.documentElement);
        const textColor  = cs.getPropertyValue('--text')   || '#111';
        const borderCol  = cs.getPropertyValue('--border') || '#e5e5e5';
        const mutedColor = cs.getPropertyValue('--muted')  || '#666';
        const incomeCol  = cs.getPropertyValue('--accent-2') || '#cde';
        const spentCol   = cs.getPropertyValue('--accent')   || '#36c';

        const months = this.activeMonths();
        const show   = months.slice(-6);

        const chartNote = $('#chartNote');

        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        ctx.textBaseline = 'alphabetic';
        ctx.fillStyle = textColor;

        if(!show.length){
          ctx.textAlign = 'center';
          ctx.fillStyle = mutedColor;
          ctx.fillText('No data yet', W / 2, H / 2);
          if(chartNote){
            chartNote.textContent = 'Add expenses in the Budget tab to see your history.';
          }
          return;
        }

        // data in display currency
        const stipendEUR = App.state.settings.stipendEUR || 0;
        const incomeDisp = show.map(_  => Util.eurToDisp(stipendEUR));
        const spentDisp  = show.map(ym => Util.eurToDisp((App.state.expenses[ym] || [])
                                   .reduce((s, e) => s + e.amountEUR, 0)));

        const padL = 54, padR = 12, padT = 56, padB = 32; // extra left/top for labels and legend
        const plotW = W - padL - padR;
        const plotH = H - padT - padB;

        // legend
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = textColor;
        ctx.fillText('Income', padL, 18);
        ctx.fillText('Spent',  padL + 90, 18);
        ctx.fillStyle = incomeCol; ctx.fillRect(padL - 28, 12, 12, 8);
        ctx.fillStyle = spentCol;  ctx.fillRect(padL + 62, 12, 12, 8);

        // y scale
        const maxValRaw = Math.max(1, ...incomeDisp, ...spentDisp);
        const magnitude = Math.pow(10, Math.floor(Math.log10(maxValRaw)));
        const niceStep  = magnitude / 2;
        const yMax      = Math.ceil(maxValRaw / niceStep) * niceStep;

        const y = v => padT + plotH * (1 - v / yMax);

        // gridlines and y labels
        const ticks = 4;
        ctx.save();
        for(let i = 0; i <= ticks; i++){
          const v  = (yMax / ticks) * i;
          const yy = y(v);

          // line
          ctx.beginPath();
          ctx.strokeStyle = borderCol;
          ctx.globalAlpha = i === 0 ? 0.9 : 0.3;
          ctx.moveTo(padL, yy);
          ctx.lineTo(W - padR, yy);
          ctx.stroke();

          // label (skip if not a nice number)
          ctx.globalAlpha = 1;
          ctx.fillStyle = mutedColor;
          ctx.textAlign = 'right';
          ctx.textBaseline = 'middle';

          const label = Util.money(v).replace(/\.00$/, '');
          ctx.fillText(label, padL - 6, yy);
        }
        ctx.restore();

        // x groups and bars
        const n = show.length || 1;
        const groupW = plotW / n;
        const barW   = Math.min(26, (groupW - 14) / 2);

        for(let i = 0; i < n; i++){
          const xCenter = padL + i * groupW + groupW / 2;
          const groupLeft = xCenter - (2 * barW + 8) / 2;

          // vertical guideline
          ctx.save();
          ctx.beginPath();
          ctx.strokeStyle = borderCol;
          ctx.globalAlpha = 0.2;
          ctx.moveTo(xCenter, padT);
          ctx.lineTo(xCenter, padT + plotH);
          ctx.stroke();
          ctx.restore();

          const incomeVal = incomeDisp[i];
          const spentVal  = spentDisp[i];

          const ih = plotH * (incomeVal / yMax);
          const sh = plotH * (spentVal  / yMax);

          const incomeX = groupLeft;
          const spentX  = groupLeft + barW + 8;

          // income bar
          ctx.fillStyle = incomeCol;
          ctx.fillRect(incomeX, y(incomeVal), barW, ih);

          // spent bar
          ctx.fillStyle = spentCol;
          ctx.fillRect(spentX, y(spentVal), barW, sh);

          // spent value label above bar
          if(spentVal > 0){
            ctx.fillStyle = textColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            const txt = Util.money(spentVal).replace(/\.00$/, '');
            const tx = spentX + barW / 2;
            const ty = y(spentVal) - 4;
            ctx.fillText(txt, tx, ty);
          }

          // month label on x axis
          ctx.fillStyle = mutedColor;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'alphabetic';
          const lbl = new Date(show[i] + '-01').toLocaleString(undefined, { month: 'short' });
          ctx.fillText(lbl, xCenter, H - 10);
        }

        if(chartNote){
          chartNote.textContent = `Showing last ${show.length} month${show.length === 1 ? '' : 's'} with recorded expenses.`;
        }
      }
    };

    const Profile = {
      render(){
        const S = App.state;
        const scur = S.settings.stipendInputCurrency || 'USD';
        $('#stipendCur').value = scur;
        const stipendValue = scur === 'EUR' ? (S.settings.stipendEUR || 0) : (S.settings.stipendEUR || 0) * (S.settings.fx || 1.08);
        $('#stipend').value = (stipendValue || 0).toFixed(2);
        $('#currency').value = S.settings.currency;
        $('#fx').value = S.settings.fx;
        $('#startMonth').value = S.settings.startMonth;
        const sym = scur==='EUR' ? '€' : '$';
        const nba = $('#newBinAmt'); if(nba) nba.placeholder = 'Amount / month ('+sym+')';
        this.renderBins();
      },
      save(){
        const S = App.state;
        const scurSel = $('#stipendCur').value;
        const stipendRaw = parseFloat($('#stipend').value || '0');
        const fx = parseFloat($('#fx').value || '1.08');
        S.settings.stipendEUR = scurSel === 'EUR' ? stipendRaw : (stipendRaw / fx);
        S.settings.stipendInputCurrency = scurSel;
        S.settings.currency  = $('#currency').value;
        S.settings.fx        = fx;
        S.settings.startMonth= $('#startMonth').value || Util.fmtYM(new Date());
        App.save();
        $('#saveNote').textContent = 'Saved ✓'; setTimeout(()=>$('#saveNote').textContent=' ', 1200);
        Budget.render(); Overview.render(); this.renderBins();
      },
      renderBins(){
        const host = $('#binList'); host.innerHTML='';
        const bins = App.state.bins;
        const scur = App.state.settings.stipendInputCurrency || 'USD';
        bins.forEach((b, idx)=>{
          const dispAmt = Util.eurToStipendDisp(b.monthlyEUR || 0);
          const card = document.createElement('div'); card.className='card item'; card.style.padding='0';
          card.innerHTML = `
            <div style="flex:1; padding:12px;">
              <div class="bin-row">
                <input data-k="name" data-id="${b.id}" type="text" value="${b.name}" class="fld" />
                <input data-k="amount" data-id="${b.id}" type="number" inputmode="decimal" step="0.01" value="${(dispAmt||0).toFixed(2)}" class="fld" />
                <div class="bin-actions">
                  <button class="button ghost" onclick="Profile.moveBin('${b.id}', -1)" ${idx===0?'disabled':''}>▲</button>
                  <button class="button ghost" onclick="Profile.moveBin('${b.id}', 1)" ${idx===bins.length-1?'disabled':''}>▼</button>
                  <button class="button ghost" onclick="Profile.delBin('${b.id}')">Delete</button>
                </div>
              </div>
            </div>`;
          host.appendChild(card);
        });
        $$('#binList input[data-k]').forEach(inp=>{
          inp.addEventListener('change', (e)=>{
            const id = e.target.dataset.id; const k = e.target.dataset.k;
            const bin = App.state.bins.find(x=>x.id===id); if(!bin) return;
            if(k==='name'){
              bin.name = e.target.value;
            }else{
              const raw = parseFloat(e.target.value||'0');
              bin.monthlyEUR = Util.stipendDispToEur(raw);
            }
            App.save(); Budget.render(); Overview.render();
          });
        });
      },
      moveBin(id, dir){
        const a = App.state.bins;
        const i = a.findIndex(b=>b.id===id); if(i<0) return;
        const j = i + dir; if(j<0 || j>=a.length) return;
        const [item] = a.splice(i,1); a.splice(j,0,item);
        App.save(); this.renderBins(); Budget.render();
      },
      addBin(){
        const name = $('#newBinName').value.trim();
        const amtDisp = parseFloat($('#newBinAmt').value||'0');
        if(!name) return alert('Enter a bin name');
        const monthlyEUR = Util.stipendDispToEur(amtDisp);
        App.state.bins.push({id:Util.id(), name, monthlyEUR});
        $('#newBinName').value=''; $('#newBinAmt').value='';
        App.save(); this.renderBins(); Budget.render(); Overview.render();
      },
      delBin(id){
        if(!confirm('Delete this bin?')) return;
        App.state.bins = App.state.bins.filter(b=>b.id!==id);
        App.save(); this.renderBins(); Budget.render(); Overview.render();
      }
    };

    const Budget = {
      pendingBinId: null,
      shiftMonth(delta){
        const [y,m] = UI.currentYM.split('-').map(Number);
        const d = new Date(y, m-1+delta, 1);
        UI.currentYM = Util.fmtYM(d);
        this.render();
      },
      openDialog(binId){
        this.pendingBinId = binId;
        $('#dlgTitle').textContent = 'Add to ' + (App.state.bins.find(b=>b.id===binId)?.name || 'Bin');
        $('#dlgCur').textContent = App.state.settings.currency==='EUR' ? '€' : '$';
        $('#dlgName').value = '';
        $('#dlgAmt').value = '';
        $('#addDialog').showModal();
        setTimeout(()=>$('#dlgName').focus(), 50);
      },
      saveDialog(ev){
        ev.preventDefault();
        const name = $('#dlgName').value.trim();
        const amtDisp = parseFloat($('#dlgAmt').value||'0');
        if(!name || !(amtDisp>0)) { $('#addDialog').close(); return; }
        Util.ensureMonth(UI.currentYM);
        const amountEUR = Util.dispToEur(amtDisp);
        const today = new Date().toISOString().slice(0,10);
        App.state.expenses[UI.currentYM].push({id:Util.id(), date:today, binId:this.pendingBinId, name, amountEUR});
        App.save(); $('#addDialog').close(); this.render(); Overview.render();
      },
      editExpense(expId){
        const arr = App.state.expenses[UI.currentYM]; const i = arr.findIndex(e=>e.id===expId); if(i<0) return;
        const e = arr[i];
        const newName = prompt('Name', e.name||''); if(newName===null) return; e.name=newName;
        const newAmt  = prompt('Amount ('+(App.state.settings.currency==='EUR'?'€':'$')+')', Util.eurToDisp(e.amountEUR).toFixed(2)); if(newAmt===null) return; e.amountEUR = Util.dispToEur(parseFloat(newAmt||'0'));
        App.save(); this.render(); Overview.render();
      },
      delExpense(expId){
        if(!confirm('Delete expense?')) return;
        const arr=App.state.expenses[UI.currentYM];
        const i=arr.findIndex(e=>e.id===expId);
        if(i>=0){ arr.splice(i,1); App.save(); this.render(); Overview.render(); }
      },
      render(){
        const S = App.state;
        if(!UI.currentYM) UI.currentYM = S.settings.startMonth || Util.fmtYM(new Date());
        Util.ensureMonth(UI.currentYM);
        $('#monthLabel').textContent = Util.labelYM(UI.currentYM);

        const totals = Object.fromEntries(S.bins.map(b=>[b.id,0]));
        App.state.expenses[UI.currentYM].forEach(e => totals[e.binId] = (totals[e.binId] || 0) + e.amountEUR);

        const host = $('#binsSummary'); host.innerHTML = '';
        S.bins.forEach(b => {
          const spent = totals[b.id] || 0;
          const budget = b.monthlyEUR || 0;
          const pct = Math.min(100, Math.max(0, budget > 0 ? (spent / budget) * 100 : 0));
          const over = (budget - spent) < 0;

          const card = document.createElement('div');
          card.className = 'card'; card.style.padding='14px'; card.style.cursor='pointer';
          card.setAttribute('role','button'); card.setAttribute('aria-label','Add expense to '+b.name);
          card.onclick = () => Budget.openDialog(b.id);

          card.innerHTML = `
            <div class="item" style="padding:0; gap:10px;">
              <div style="flex:1">
                <h3 style="margin:0 0 6px;">${b.name}</h3>
                <div style="height:10px; background:var(--accent-2, #cde); border-radius:999px; overflow:hidden;">
                  <div style="height:100%; width:${pct}%; background:var(--accent, #36c);"></div>
                </div>
                <div class="meta" style="display:flex; gap:8px; margin-top:6px;">
                  <span class="badge" style="border-style:${over ? 'solid' : 'dashed'}; ${over ? 'color:#b00020;' : ''}">
                    ${Util.money(Util.eurToDisp(spent))} / ${Util.money(Util.eurToDisp(budget))} spent
                  </span>
                </div>
              </div>
            </div>`;
          host.appendChild(card);
        });

        const list = $('#expenseList'); list.innerHTML='';
        const items = App.state.expenses[UI.currentYM];
        $('#noExpenses').style.display = items.length? 'none' : 'block';
        items.slice().reverse().forEach(e=>{
          const bin = S.bins.find(b=>b.id===e.binId);
          const row = document.createElement('div'); row.className='card item';
          row.innerHTML = `
            <div style="flex:1">
              <h3>${e.name||'(untitled)'}</h3>
              <div class="meta">${new Date(e.date).toLocaleDateString()} · ${bin?bin.name:'(bin deleted)'}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700">${Util.money(Util.eurToDisp(e.amountEUR))}</div>
              <div class="meta"><a href="#" onclick="Budget.editExpense('${e.id}'); return false;">Edit</a> · <a href="#" onclick="Budget.delExpense('${e.id}'); return false;">Delete</a></div>
            </div>`;
          list.appendChild(row);
        });
      }
    };

    App.load();
    UI.switchTab('budget');
  </script>
</body>
</html>
