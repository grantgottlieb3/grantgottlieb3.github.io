<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spanish Immersion — Conversational Web App | Grant Gottlieb</title>
  <meta name="description" content="Replayable, city-specific Spanish conversation practice powered by AI." />
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="assets/headshot-placeholder.svg" />

  <!-- Page-only tweaks (keeps site brand) -->
  <style>
    /* Links are plain unless buttons */
    a { text-decoration: none; color: inherit; }
    a:hover, a:focus { opacity: .95; }
    a.button { color: #fff !important; }
    .button.ghost { color: var(--text) !important; background: transparent; border: 1px solid var(--border); }
    .button.ghost:hover { background: var(--accent-2); }
    .muted { color: var(--muted); }

    /* Remove donut logos only on this page */
    .item .logo { display: none !important; }

    /* Hero: title only */
    .hero { grid-template-columns: 1fr !important; padding-bottom: 12px; }
    .hero .title { margin-bottom: 0; }
    .hero .headshot { display: none !important; }

    /* Controls */
    .controls { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .controls { grid-template-columns: repeat(3, 1fr); } }
    .control { display: grid; gap: 6px; }
    .control label { font-size: 13px; color: var(--muted); }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: var(--card); color: var(--text);
      font: inherit;
    }

    /* HUD / Gamification */
    .hud { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) { .hud { grid-template-columns: 1fr 1fr; } }
    .stat { display:flex; align-items:center; justify-content:space-between; gap: 12px; }
    .bar { height: 8px; background: var(--accent-2); border-radius: 999px; overflow:hidden; }
    .bar > i { display:block; height:100%; background: var(--accent); width: 0%; transition: width .3s ease; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .tab-btn {
      border: 1px solid var(--border); background: var(--card);
      border-radius: 999px; padding: 8px 12px; cursor: pointer; font-weight: 600;
    }
    .tab-btn.active { background: var(--text); color: #fff; }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Scene cards */
    .scene-card .content { padding: 16px; }
    .scene-card h4 { margin: 0 0 6px; font-size: 16px; }
    .scene-card p { margin: 0; color: var(--muted); }

    /* Custom scene input row */
    .custom-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin: 8px 0 0; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(0,0,0,.35); z-index: 1000; padding: 20px;
    }
    .modal.open { display: grid; }
    .modal .sheet {
      width: min(720px, 100%); background: var(--card); color: var(--text);
      border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
      overflow: hidden; transform: scale(.98); opacity: 0; animation: pop .18s ease forwards;
    }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }
    .sheet header { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); }
    .sheet header h3 { margin:0; font-size:18px; }
    .sheet .body { padding: 14px 16px; display: grid; gap: 12px; }
    .sheet .row { display: grid; gap: 4px; }
    .sheet .row small { color: var(--muted); }
    .sheet footer { padding: 14px 16px; border-top: 1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; flex-wrap: wrap; }

    /* Avatar */
    .partner {
      display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border);
      border-radius: 12px; background: var(--card);
    }
    .avatar {
      width: 72px; height: 72px; border-radius: 16px; overflow: hidden; flex-shrink:0;
      border: 1px solid var(--border); background: transparent;
    }
    .avatar img.avatar-img { width:100%; height:100%; object-fit:cover; display:block; border-radius:16px; }

    textarea.notes { width: 100%; min-height: 70px; resize: vertical; padding:10px; border-radius:10px; border:1px solid var(--border); }

    /* Small helper */
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color: var(--accent); border-radius:50%; animation: spin .6s linear infinite; vertical-align: -3px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<header class="header">
  <div class="container nav">
    <div class="left"><a href="index.html" class="brand">Grant Gottlieb</a></div>
    <nav class="right"><a href="index.html#projects">← Back to Projects</a></nav>
  </div>
</header>

<main class="container">
  <!-- =============================== Hero (title only) =============================== -->
  <section class="hero" id="top">
    <div>
      <h1 class="title">Spanish Immersion — Conversational Web App</h1>
    </div>
  </section>

  <!-- =============================== Customization =============================== -->
  <section id="customization">
    <div class="section-title"><h2>Customization</h2><div class="line"></div></div>
    <article class="card item">
      <div>
        <div class="controls">
          <div class="control">
            <label for="langSel">Language</label>
            <select id="langSel">
              <option>Spanish</option>
              <option>English</option>
            </select>
          </div>

          <div class="control">
            <label for="citySel">City (Spain)</label>
            <select id="citySel">
              <option>Madrid</option>
              <option>Barcelona</option>
              <option>Valencia</option>
              <option>Sevilla</option>
              <option>Bilbao</option>
              <option>Málaga</option>
              <option>Granada</option>
              <option>Zaragoza</option>
              <option>Salamanca</option>
              <option>Córdoba</option>
              <option>San Sebastián</option>
              <option>Torrevieja</option>
            </select>
          </div>

          <div class="control">
            <label for="levelSel">CEFR Level</label>
            <select id="levelSel">
              <option>A1</option>
              <option>A2</option>
              <option selected>B1</option>
              <option>B2</option>
              <option>C1</option>
              <option>C2</option>
            </select>
          </div>
        </div>
        <div class="muted" style="margin-top:8px;">Choices persist in your browser for next visit.</div>
      </div>
    </article>
  </section>

  <!-- =============================== HUD / Gamification =============================== -->
  <section id="hud">
    <div class="section-title"><h2>Progress</h2><div class="line"></div></div>
    <div class="hud">
      <article class="card item">
        <div style="width:100%;">
          <div class="stat"><strong>XP</strong><span id="xpVal">0</span></div>
          <div class="bar" aria-hidden="true"><i id="xpBar" style="width:0%"></i></div>
          <div class="muted" style="margin-top:6px;">Earn 50 XP per completed scenario.</div>
        </div>
      </article>
      <article class="card item">
        <div style="width:100%;">
          <div class="stat"><strong>Streak</strong><span id="streakVal">0 days</span></div>
          <div class="muted" style="margin-top:6px;">Complete at least one scenario per day to build your streak.</div>
        </div>
      </article>
    </div>
    <div class="grid cols-3" style="margin-top:12px;">
      <article class="card item"><div><strong>Travel</strong><div class="muted"><span id="c-travel">0</span> completed</div></div></article>
      <article class="card item"><div><strong>Food</strong><div class="muted"><span id="c-food">0</span> completed</div></div></article>
      <article class="card item"><div><strong>Daily</strong><div class="muted"><span id="c-daily">0</span> completed</div></div></article>
      <article class="card item"><div><strong>Culture</strong><div class="muted"><span id="c-culture">0</span> completed</div></div></article>
      <article class="card item"><div><strong>Social</strong><div class="muted"><span id="c-social">0</span> completed</div></div></article>
      <article class="card item"><div><strong>Custom</strong><div class="muted"><span id="c-custom">0</span> completed</div></div></article>
    </div>
  </section>

  <!-- =============================== Scenes (Tabs) =============================== -->
  <section id="scenes">
    <div class="section-title"><h2>Scenes</h2><div class="line"></div></div>

    <div class="tabs" role="tablist" aria-label="Scene categories">
      <button class="tab-btn active" data-tab="travel" role="tab" aria-selected="true">Travel</button>
      <button class="tab-btn" data-tab="food" role="tab">Food</button>
      <button class="tab-btn" data-tab="daily" role="tab">Daily</button>
      <button class="tab-btn" data-tab="culture" role="tab">Culture</button>
      <button class="tab-btn" data-tab="social" role="tab">Social</button>
      <button class="tab-btn" data-tab="custom" role="tab">Custom</button>
    </div>

    <!-- Panels -->
    <div id="panel-travel" class="tab-panel active" role="tabpanel" aria-labelledby="travel">
      <div id="list-travel" class="grid"></div>
    </div>

    <div id="panel-food" class="tab-panel" role="tabpanel" aria-labelledby="food">
      <div id="list-food" class="grid"></div>
    </div>

    <div id="panel-daily" class="tab-panel" role="tabpanel" aria-labelledby="daily">
      <div id="list-daily" class="grid"></div>
    </div>

    <div id="panel-culture" class="tab-panel" role="tabpanel" aria-labelledby="culture">
      <div id="list-culture" class="grid"></div>
    </div>

    <div id="panel-social" class="tab-panel" role="tabpanel" aria-labelledby="social">
      <div id="list-social" class="grid"></div>
    </div>

    <div id="panel-custom" class="tab-panel" role="tabpanel" aria-labelledby="custom">
      <article class="card item">
        <div style="width:100%;">
          <h3 style="margin:0 0 6px;">Custom Scenario</h3>
          <p class="muted" style="margin: 0 0 10px;">Type a keyword (e.g., “pharmacy”, “football”, “job interview”) and spawn a tailored practice scene.</p>
          <div class="custom-row">
            <input type="text" id="customKeyword" placeholder="Keyword or topic…" />
            <button class="button" id="addCustom">Generate with AI</button>
          </div>
        </div>
      </article>
      <div id="list-custom" class="grid" style="margin-top:12px;"></div>
    </div>
  </section>
</main>

<footer class="container footer">
  <div>&copy; <span id="year"></span> Grant Gottlieb</div>
  <div>Built with clean HTML/CSS/JS.</div>
</footer>

<!-- =============================== Modal =============================== -->
<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h3 id="modalTitle">Scenario Details</h3>
      <button class="button ghost" id="closeModal" aria-label="Close">Close</button>
    </header>
    <div class="body">
      <div class="partner">
        <div class="avatar" id="modalAvatar" aria-hidden="true"></div>
        <div>
          <div class="muted" style="margin-bottom:2px;">You’re talking to</div>
          <div id="modalRole" style="font-weight:600;"></div>
        </div>
      </div>

      <div class="row">
        <small>Setting</small>
        <div id="modalSetting"></div>
      </div>

      <div class="row">
        <small>Key information</small>
        <div id="modalKey"></div>
      </div>

      <div class="row">
        <small>Outcome notes (optional)</small>
        <textarea class="notes" id="modalNotes" placeholder="What happened? Any phrases to remember?"></textarea>
      </div>
    </div>
    <footer>
      <button class="button ghost" id="regenScene">AI: Reroll This Scene</button>
      <button class="button" id="markComplete">Mark Complete</button>
    </footer>
  </div>
</div>

<script>
  // Year stamp
  (function(){ const y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();

  // ============================================================
  //  AVATAR IMAGES (already swapped to PNGs as you asked)
  // ============================================================
  const AVATAR_IMAGES = ['avatar1.png','avatar2.png','avatar3.png','avatar4.png','avatar5.png'];

  // ============================================================
  //  AI CONFIG — READ THIS
  // ============================================================
  // OPTION A (LOCAL TEST ONLY — NOT SECURE FOR PROD):
  //   Set USE_DIRECT_OPENAI = true and paste your API key below.
  // OPTION B (RECOMMENDED): Leave USE_DIRECT_OPENAI = false and point AI_PROXY_URL
  //   to your own serverless function that adds the API key server-side.
  //
  // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  // TODO: SET TRUE ONLY FOR LOCAL TESTING; FALSE IF USING YOUR OWN PROXY
  const USE_DIRECT_OPENAI = false;
  //
  // TODO: IF YOU USE A SERVERLESS PROXY, SET ITS URL HERE
  // e.g., '/api/ai' on Vercel/Netlify/Cloudflare-workers
  const AI_PROXY_URL = '/api/ai';
  //
  // TODO: IF DIRECT, PASTE YOUR OPENAI API KEY HERE (LOCAL DEV ONLY)
  const OPENAI_API_KEY = 'PASTE_YOUR_OPENAI_API_KEY_HERE';
  //
  // TODO: SET YOUR MODEL NAME
  const OPENAI_MODEL = 'gpt-4o-mini';
  // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

  // Central AI call
  async function callAI(systemPrompt, userPrompt, temperature=0.8) {
    try {
      if (USE_DIRECT_OPENAI) {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}` // <<< DO NOT SHIP THIS TO PROD
          },
          body: JSON.stringify({
            model: OPENAI_MODEL,
            temperature,
            response_format: { type: 'json_object' },
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: userPrompt }
            ]
          })
        });
        const data = await res.json();
        const text = data?.choices?.[0]?.message?.content || '';
        return safeParseJSON(text);
      } else {
        // Your proxy should accept { system, user, temperature } and return JSON
        const res = await fetch(AI_PROXY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, user: userPrompt, temperature })
        });
        const data = await res.json();
        // Expect your proxy to already return an object. If it's text, try parse.
        return typeof data === 'string' ? safeParseJSON(data) : data;
      }
    } catch (e) {
      console.error('AI error', e);
      return null;
    }
  }

  function safeParseJSON(s) {
    if (!s) return null;
    try { return JSON.parse(s); } catch (_) {}
    // try to extract a JSON object if wrapped in prose or code fences
    const start = s.indexOf('{'); const end = s.lastIndexOf('}');
    if (start !== -1 && end !== -1 && end > start) {
      try { return JSON.parse(s.slice(start, end+1)); } catch (_) {}
    }
    return null;
  }

  // ============================================================
  //  STATE / PERSISTENCE
  // ============================================================
  const STORE = {
    langKey: 'spanish_app_lang',
    cityKey: 'spanish_app_city',
    levelKey: 'spanish_app_level',
    listsKey: 'spanish_app_lists_v2',  // bumped key since logic changed
    logKey:   'spanish_app_log',
    xpKey:    'spanish_app_xp',
    streakKey:'spanish_app_streak'
  };

  const langSel  = document.getElementById('langSel');
  const citySel  = document.getElementById('citySel');
  const levelSel = document.getElementById('levelSel');

  langSel.value  = localStorage.getItem(STORE.langKey)  || 'Spanish';
  citySel.value  = localStorage.getItem(STORE.cityKey)  || 'Madrid';
  levelSel.value = localStorage.getItem(STORE.levelKey) || 'B1';

  langSel.addEventListener('change', () => { localStorage.setItem(STORE.langKey, langSel.value); regenerateSeeds(); });
  citySel.addEventListener('change', () => { localStorage.setItem(STORE.cityKey, citySel.value); regenerateSeeds(); });
  levelSel.addEventListener('change', () => { localStorage.setItem(STORE.levelKey, levelSel.value); regenerateSeeds(); });

  function getXP(){ return +(localStorage.getItem(STORE.xpKey) || 0); }
  function setXP(v){ localStorage.setItem(STORE.xpKey, String(v)); }
  function getStreak(){
    try { return JSON.parse(localStorage.getItem(STORE.streakKey) || '{"count":0,"last":""}'); }
    catch { return {count:0, last:""}; }
  }
  function setStreak(obj){ localStorage.setItem(STORE.streakKey, JSON.stringify(obj)); }
  function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

  function getLog(){
    try { return JSON.parse(localStorage.getItem(STORE.logKey) || '[]'); }
    catch { return []; }
  }
  function addLogEntry(entry){
    const log = getLog();
    log.push(entry);
    localStorage.setItem(STORE.logKey, JSON.stringify(log));
  }
  function recentHistory(category, n=3){
    return getLog().filter(x => x.category === category).slice(-n);
  }

  // Scene lists per category
  const categories = ['travel','food','daily','culture','social','custom'];
  let lists = loadLists();
  function loadLists() {
    try {
      const raw = localStorage.getItem(STORE.listsKey);
      if (!raw) return { travel:[], food:[], daily:[], culture:[], social:[], custom:[] };
      return JSON.parse(raw);
    } catch {
      return { travel:[], food:[], daily:[], culture:[], social:[], custom:[] };
    }
  }
  function saveLists(){ localStorage.setItem(STORE.listsKey, JSON.stringify(lists)); }

  // ============================================================
  //  HUD (XP, streak, counts)
  // ============================================================
  const hud = {
    xpVal: document.getElementById('xpVal'),
    xpBar: document.getElementById('xpBar'),
    streakVal: document.getElementById('streakVal'),
    counts: {
      travel: document.getElementById('c-travel'),
      food: document.getElementById('c-food'),
      daily: document.getElementById('c-daily'),
      culture: document.getElementById('c-culture'),
      social: document.getElementById('c-social'),
      custom: document.getElementById('c-custom'),
    }
  };

  function updateHUD(){
    const xp = getXP();
    hud.xpVal.textContent = xp;
    const pct = Math.min(100, ((xp % 500) / 500) * 100);
    hud.xpBar.style.width = pct + '%';

    const st = getStreak();
    hud.streakVal.textContent = `${st.count} day${st.count===1?'':'s'}`;

    const byCat = {travel:0,food:0,daily:0,culture:0,social:0,custom:0};
    getLog().forEach(x => { if(byCat[x.category] !== undefined) byCat[x.category]++; });
    Object.keys(byCat).forEach(k => { hud.counts[k].textContent = byCat[k]; });
  }

  function awardCompletion(category){
    setXP(getXP() + 50);
    const st = getStreak();
    const t  = todayStr();
    if (!st.last) { setStreak({count:1, last:t}); }
    else if (st.last !== t) {
      const prev = new Date(st.last), now  = new Date();
      const diffDays = Math.round((now - prev) / 86400000);
      setStreak({count: diffDays === 1 ? (st.count + 1) : 1, last: t});
    }
    updateHUD();
  }

  // ============================================================
  //  RENDERING
  // ============================================================
  const containers = {
    travel:  document.getElementById('list-travel'),
    food:    document.getElementById('list-food'),
    daily:   document.getElementById('list-daily'),
    culture: document.getElementById('list-culture'),
    social:  document.getElementById('list-social'),
    custom:  document.getElementById('list-custom')
  };

  function renderAll() { categories.forEach(renderCategory); updateHUD(); }

  function renderCategory(category) {
    const root = containers[category];
    if (!root) return;
    root.innerHTML = '';
    const arr = lists[category] || [];
    if (!arr.length && category !== 'custom') {
      // show a loading card while we ask AI for the city-specific seed
      const ld = document.createElement('article');
      ld.className = 'card scene-card';
      ld.innerHTML = `<div class="content"><h4>Generating ${capitalize(category)} scene <span class="spinner" aria-hidden="true"></span></h4><p class="muted">Tailoring to ${citySel.value}…</p></div>`;
      root.appendChild(ld);
      // kick off seed
      aiSeedCategory(category);
      return;
    }
    arr.forEach(item => { root.appendChild(renderSceneCard(item)); });
  }

  function renderSceneCard(scn) {
    const el = document.createElement('article');
    el.className = 'card scene-card';
    el.innerHTML = `
      <div class="content">
        <h4>${scn.title}</h4>
        <p>${scn.brief}</p>
        <div class="actions" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="button ghost" data-act="details" data-id="${scn.id}" data-cat="${scn.category}">Details</button>
        </div>
      </div>
    `;
    return el;
  }

  // ============================================================
  //  TABS
  // ============================================================
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    });
  });

  // ============================================================
  //  MODAL
  // ============================================================
  const modal = document.getElementById('modal');
  const closeModalBtn = document.getElementById('closeModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalRole = document.getElementById('modalRole');
  const modalSetting = document.getElementById('modalSetting');
  const modalKey = document.getElementById('modalKey');
  const modalAvatar = document.getElementById('modalAvatar');
  const modalNotes = document.getElementById('modalNotes');
  const regenBtn = document.getElementById('regenScene');
  const completeBtn = document.getElementById('markComplete');

  let current = null;

  function openModal(scn) {
    current = scn;
    modalTitle.textContent = scn.title;
    modalRole.textContent = scn.role || 'Conversation partner';
    modalSetting.textContent = scn.setting || '(AI-generated setting)';
    modalKey.innerHTML = Array.isArray(scn.key) && scn.key.length
      ? `<ul style="margin:0 0 0 18px;">${scn.key.map(k=>`<li>${k}</li>`).join('')}</ul>`
      : '<span class="muted">Key points will be generated by AI.</span>';
    modalNotes.value = '';
    const pick = AVATAR_IMAGES[Math.floor(Math.random() * AVATAR_IMAGES.length)];
    modalAvatar.innerHTML = `<img src="${pick}" alt="Conversation partner avatar" class="avatar-img" loading="lazy">`;
    modal.classList.add('open');
  }
  function closeModal(){ modal.classList.remove('open'); current = null; }
  closeModalBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  document.getElementById('scenes').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-act="details"]');
    if (!btn) return;
    const cat = btn.getAttribute('data-cat');
    const id  = btn.getAttribute('data-id');
    const scn = (lists[cat] || []).find(s => s.id === id);
    if (scn) openModal(scn);
  });

  // Reroll current scene with AI (same category+city+level)
  regenBtn.addEventListener('click', async () => {
    if (!current) return;
    regenBtn.disabled = true; regenBtn.textContent = 'Re-rolling…';
    const repl = await aiGenerateScene(current.category);
    if (repl) {
      // Replace the card where current lives
      const arr = lists[current.category];
      const idx = arr.findIndex(x => x.id === current.id);
      if (idx !== -1) {
        arr[idx] = repl;
        saveLists(); renderCategory(current.category);
        openModal(repl);
      }
    }
    regenBtn.disabled = false; regenBtn.textContent = 'AI: Reroll This Scene';
  });

  // Complete → log + XP + ask AI for NEXT scene and append it
  completeBtn.addEventListener('click', async () => {
    if (!current) return;
    const cat = current.category;
    const notes = modalNotes.value.trim();

    addLogEntry({ ts: Date.now(), category: cat, title: current.title, notes });
    awardCompletion(cat);

    closeModal();

    // Show small loading placeholder below
    const placeholder = {
      id: `${cat}-loading-${Date.now()}`,
      category: cat,
      title: 'Generating next scenario…',
      brief: `Asking AI to continue your ${capitalize(cat)} storyline for ${citySel.value} <span class="spinner"></span>`,
      role: '', setting: '', key: []
    };
    lists[cat].push(placeholder); saveLists(); renderCategory(cat);

    // Ask AI for the next scene using the last one + recent notes
    const next = await aiGenerateNextScene(cat, current);
    // Replace placeholder
    const arr = lists[cat];
    const pIdx = arr.findIndex(x => x.id === placeholder.id);
    if (next && pIdx !== -1) { arr[pIdx] = next; saveLists(); renderCategory(cat); }
  });

  // ============================================================
  //  AI SCENE GENERATION
  // ============================================================
  function baseSystemPrompt(){
    return `
You generate *city-specific* conversation scenes for a Spanish immersion app.

Output strictly as JSON (no prose), matching this schema:
{
  "title": "string",
  "brief": "1–2 sentence description",
  "role": "who the learner is talking to",
  "setting": "where it happens (city-specific)",
  "key": ["3–5 bullet points"],
  "goal": "clear outcome to reach"
}

Rules:
- Use the given City (Spain), Language and CEFR Level to tune names, transit, and cultural detail.
- If the selected city doesn't have an airport (e.g., Torrevieja), route through the nearest major airport (e.g., Alicante–Elche) and continue by realistic transport (bus/coach/regional rail).
- Keep it practical and plausible for that city (Metro, Cercanías, barrios, plazas, customs, hours).
- Avoid brand-new factual claims that are likely wrong; prefer generic but city-colored details.
- Keep titles short and clear; keep "key" items actionable.
- Do not start the conversation; just return the JSON.
`.trim();
  }

  function seedUserPrompt(category){
    const lang  = langSel.value;
    const city  = citySel.value;
    const level = levelSel.value;
    const label = capitalize(category);
    return `
Language: ${lang}
City: ${city}
CEFR level: ${level}
Category: ${label}

Task: Propose the very first practice scene a newcomer would realistically face in this category in ${city}. Make it authentic to ${city} specifically.
`.trim();
  }

  function nextUserPrompt(category, lastScene){
    const lang  = langSel.value;
    const city  = citySel.value;
    const level = levelSel.value;
    const history = recentHistory(category, 3).map(x => `- ${x.title}${x.notes?`: ${x.notes}`:''}`).join('\n') || '(none)';
    return `
Language: ${lang}
City: ${city}
CEFR level: ${level}
Category: ${capitalize(category)}

Last scene JSON:
${JSON.stringify(stripId(lastScene), null, 2)}

Recent outcomes in this category:
${history}

Task: Propose the next logical scene that builds difficulty slightly and stays authentic to ${city}.
`.trim();
  }

  function stripId(obj){ const {id, category, ...rest} = obj; return rest; }

  async function aiSeedCategory(category){
    const scene = await aiGenerateScene(category);
    if (scene) {
      lists[category] = [scene]; saveLists(); renderCategory(category);
    } else {
      // On failure, show a manual card so the user can still practice
      lists[category] = [{
        id: `${category}-fallback`,
        category,
        title: `${capitalize(category)} — Manual Start`,
        brief: `Couldn’t reach AI. Click Details and use your own idea to begin.`,
        role: 'Local person',
        setting: `${citySel.value}`,
        key: ['Set a clear goal', 'Keep turns short', 'Ask follow-ups'],
        goal: 'Have a short, realistic chat'
      }];
      saveLists(); renderCategory(category);
    }
  }

  async function aiGenerateScene(category){
    const sys = baseSystemPrompt();
    const usr = seedUserPrompt(category);
    const obj = await callAI(sys, usr, 0.9);
    if (!obj) return null;
    return normalizeScene(obj, category);
  }

  async function aiGenerateNextScene(category, lastScene){
    const sys = baseSystemPrompt();
    const usr = nextUserPrompt(category, lastScene);
    const obj = await callAI(sys, usr, 0.9);
    if (!obj) return null;
    return normalizeScene(obj, category);
  }

  function normalizeScene(obj, category){
    // guard + assign id
    const title = (obj.title || 'Scene').toString().slice(0, 120);
    const brief = (obj.brief || '').toString().slice(0, 240);
    const role  = (obj.role || 'Conversation partner').toString().slice(0, 120);
    const setting = (obj.setting || citySel.value).toString().slice(0, 200);
    const key = Array.isArray(obj.key) ? obj.key.slice(0,5).map(x=>x.toString().slice(0,120)) : [];
    const goal = (obj.goal || '').toString().slice(0, 160);
    return {
      id: `${category}-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,
      category, title, brief, role, setting, key, goal
    };
  }

  // Regenerate all seeds when city/lang/level changes
  async function regenerateSeeds(){
    lists = { travel:[], food:[], daily:[], culture:[], social:[], custom:[] };
    saveLists();
    renderAll(); // shows "Generating…" placeholders which will call aiSeedCategory
  }

  // ============================================================
  //  CUSTOM SCENES (keyword → AI)
  // ============================================================
  document.getElementById('addCustom').addEventListener('click', async () => {
    const kw = (document.getElementById('customKeyword').value || '').trim();
    if (!kw) { alert('Please enter a keyword.'); return; }
    const sys = baseSystemPrompt();
    const usr = `
${seedUserPrompt('custom')}

Extra requirement: Build the first scene around this keyword: "${kw}".
`.trim();
    const obj = await callAI(sys, usr, 0.9);
    const scn = obj ? normalizeScene(obj, 'custom') : {
      id:`custom-${Date.now()}`, category:'custom',
      title:`Custom: ${capitalize(kw)}`, brief:`Practice focused on “${kw}” in ${citySel.value}.`,
      role:'Local person', setting: citySel.value, key:['Define your goal','Ask relevant questions','Summarize outcome'], goal:'Make clear progress'
    };
    lists.custom.push(scn); saveLists(); renderCategory('custom');
    document.getElementById('customKeyword').value = '';
  });

  // ============================================================
  //  BOOTSTRAP
  // ============================================================
  renderAll();

  // ============================================================
  //  UTIL
  // ============================================================
  function capitalize(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
</script>
</body>
</html>
