<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spanish Immersion — Conversational Web App | Grant Gottlieb</title>
  <meta name="description" content="Replayable, city-specific Spanish conversation practice powered by AI." />
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="assets/headshot-placeholder.svg" />
  <style>
    a { text-decoration: none; color: inherit; }
    a:hover, a:focus { opacity: .95; }
    a.button { color: #fff !important; }
    .button.ghost { color: var(--text) !important; background: transparent; border: 1px solid var(--border); }
    .button.ghost:hover { background: var(--accent-2); }
    .muted { color: var(--muted); }
    .item .logo { display: none !important; }
    .hero { grid-template-columns: 1fr !important; padding-bottom: 12px; }
    .hero .title { margin-bottom: 0; }
    .hero .headshot { display: none !important; }
    .controls { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .controls { grid-template-columns: repeat(3, 1fr); } }
    .control { display: grid; gap: 6px; }
    .control label { font-size: 13px; color: var(--muted); }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: var(--card); color: var(--text);
      font: inherit;
    }
    .hud { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) { .hud { grid-template-columns: 1fr 1fr; } }
    .stat { display:flex; align-items:center; justify-content:space-between; gap: 12px; }
    .bar { height: 8px; background: var(--accent-2); border-radius: 999px; overflow:hidden; }
    .bar > i { display:block; height:100%; background: var(--accent); width: 0%; transition: width .3s ease; }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .tab-btn {
      border: 1px solid var(--border); background: var(--card);
      border-radius: 999px; padding: 8px 12px; cursor: pointer; font-weight: 600;
    }
    .tab-btn.active { background: var(--text); color: #fff; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .scene-card .content { padding: 16px; }
    .scene-card h4 { margin: 0 0 6px; font-size: 16px; }
    .scene-card p { margin: 0; color: var(--muted); }
    .custom-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin: 8px 0 0; }
    .modal {
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(0,0,0,.35); z-index: 1000; padding: 20px;
    }
    .modal.open { display: grid; }
    .modal .sheet {
      width: min(720px, 100%); background: var(--card); color: var(--text);
      border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
      overflow: hidden; transform: scale(.98); opacity: 0; animation: pop .18s ease forwards;
    }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }
    .sheet header { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); }
    .sheet header h3 { margin:0; font-size:18px; }
    .sheet .body { padding: 14px 16px; display: grid; gap: 12px; }
    .sheet .row { display: grid; gap: 4px; }
    .sheet .row small { color: var(--muted); }
    .sheet footer { padding: 14px 16px; border-top: 1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; flex-wrap: wrap; }
    .partner { display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius: 12px; background: var(--card); }
    .avatar { width: 72px; height: 72px; border-radius: 16px; overflow: hidden; flex-shrink:0; border: 1px solid var(--border); background: transparent; }
    .avatar img.avatar-img { width:100%; height:100%; object-fit:cover; display:block; border-radius:16px; }
    textarea.notes { width: 100%; min-height: 70px; resize: vertical; padding:10px; border-radius:10px; border:1px solid var(--border); }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color: var(--accent); border-radius:50%; animation: spin .6s linear infinite; vertical-align: -3px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<main class="container">
  <!-- Hero -->
  <section class="hero" id="top">
    <div><h1 class="title">Spanish Immersion — Conversational Web App <p></p></h1></div>
  </section>

  <!-- Top-level tabs -->
  <div class="tabs view-tabs" role="tablist" aria-label="Main sections">
    <button class="tab-btn active" data-view="profile" aria-selected="true">Profile</button>
    <button class="tab-btn" data-view="scenes">Scenes</button>
  </div>

  <!-- PROFILE PANEL (Customization + Progress) -->
  <section id="view-profile" class="tab-panel active" role="tabpanel">
    <!-- Progress -->
    <section id="hud" style="margin-top:18px;">
      <div class="section-title">
        <h2>Progress</h2>
        <div class="line"></div>
      </div>

      <!-- Summary: XP + Streak -->
      <div class="hud">
        <article class="card item">
          <div>
            <div class="stat"><strong>XP</strong><span id="xpVal">0</span></div>
            <div class="bar" aria-hidden="true"><i id="xpBar"></i></div>
            <p class="muted" style="margin-top:6px;">Earn 50 XP per completed scenario.</p>
          </div>
        </article>
        <article class="card item">
          <div>
            <div class="stat"><strong>Streak</strong><span id="streakVal">0 days</span></div>
            <p class="muted" style="margin-top:6px;">Complete at least one scenario per day to build your streak.</p>
          </div>
        </article>
      </div>

      <!-- By category -->
      <div class="section-title" style="margin-top:12px;">
        <h3>By category</h3>
        <div class="line"></div>
      </div>

      <div class="grid cols-3">
        <article class="card item"><div><strong>Travel</strong><div class="muted"><span id="c-travel">0</span> completed</div></div></article>
        <article class="card item"><div><strong>Food</strong><div class="muted"><span id="c-food">0</span> completed</div></div></article>
        <article class="card item"><div><strong>Daily</strong><div class="muted"><span id="c-daily">0</span> completed</div></div></article>
        <article class="card item"><div><strong>Culture</strong><div class="muted"><span id="c-culture">0</span> completed</div></div></article>
        <article class="card item"><div><strong>Social</strong><div class="muted"><span id="c-social">0</span> completed</div></div></article>
        <article class="card item"><div><strong>Custom</strong><div class="muted"><span id="c-custom">0</span> completed</div></div></article>
      </div>
    </section>
    <!-- Customization -->
    <section id="customization">
      <div class="section-title"><h2>Customization</h2><div class="line"></div></div>
      <article class="card item">
        <div>
          <div class="controls">
            <div class="control">
              <label for="langSel">Language</label>
              <select id="langSel"><option>Spanish</option><option>English</option></select>
            </div>
            <div class="control">
              <label for="citySel">City (Spain)</label>
              <select id="citySel">
                <option>Madrid</option><option>Barcelona</option><option>Valencia</option><option>Sevilla</option>
                <option>Bilbao</option><option>Málaga</option><option>Granada</option><option>Zaragoza</option>
                <option>Salamanca</option><option>Córdoba</option><option>San Sebastián</option><option>Torrevieja</option>
              </select>
            </div>
            <div class="control">
              <label for="levelSel">CEFR Level</label>
              <select id="levelSel"><option>A1</option><option>A2</option><option selected>B1</option><option>B2</option><option>C1</option><option>C2</option></select>
            </div>
          </div>
          <div class="muted" style="margin-top:8px;">Choices persist in your browser for next visit.</div>
        </div>
      </article>
    </section>

  </section>

  <!-- SCENES PANEL -->
  <section id="view-scenes" class="tab-panel" role="tabpanel">
    <section id="scenes">
      <div class="section-title"><h2>Scenes</h2><div class="line"></div></div>

      <div class="tabs" role="tablist" aria-label="Scene categories">
        <button class="tab-btn active" data-tab="travel" role="tab" aria-selected="true">Travel</button>
        <button class="tab-btn" data-tab="food" role="tab">Food</button>
        <button class="tab-btn" data-tab="daily" role="tab">Daily</button>
        <button class="tab-btn" data-tab="culture" role="tab">Culture</button>
        <button class="tab-btn" data-tab="social" role="tab">Social</button>
        <button class="tab-btn" data-tab="custom" role="tab">Custom</button>
      </div>
      <p></p>

      <div id="panel-travel" class="tab-panel active" role="tabpanel"><div id="list-travel" class="grid"></div></div>
      <div id="panel-food" class="tab-panel" role="tabpanel"><div id="list-food" class="grid"></div></div>
      <div id="panel-daily" class="tab-panel" role="tabpanel"><div id="list-daily" class="grid"></div></div>
      <div id="panel-culture" class="tab-panel" role="tabpanel"><div id="list-culture" class="grid"></div></div>
      <div id="panel-social" class="tab-panel" role="tabpanel"><div id="list-social" class="grid"></div></div>

      <div id="panel-custom" class="tab-panel" role="tabpanel">
        <article class="card item">
          <div style="width:100%;">
            <h3 style="margin:0 0 6px;">Custom Scenario</h3>
            <p class="muted" style="margin: 0 0 10px;">Type a keyword (e.g., “pharmacy”, “football”, “job interview”) and spawn a tailored practice scene.</p>
            <div class="custom-row">
              <input type="text" id="customKeyword" placeholder="Keyword or topic…" />
              <button class="button" id="addCustom">Generate with AI</button>
            </div>
          </div>
        </article>
        <div id="list-custom" class="grid" style="margin-top:12px;"></div>
      </div>
    </section>
  </section>
</main>

<footer class="container footer">
  <div>&copy; <span id="year"></span> Grant Gottlieb</div>
  <div>Built with clean HTML/CSS/JS.</div>
</footer>

<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h3 id="modalTitle">Scenario Details</h3>
      <button class="button ghost" id="closeModal" aria-label="Close">Close</button>
    </header>
    <div class="body">
      <div class="partner">
        <div class="avatar" id="modalAvatar" aria-hidden="true"></div>
        <div>
          <div class="muted" style="margin-bottom:2px;">You’re talking to</div>
          <div id="modalRole" style="font-weight:600;"></div>
        </div>
      </div>
      <div class="row"><small>Setting</small><div id="modalSetting"></div></div>
      <div class="row"><small>Key information</small><div id="modalKey"></div></div>
      
    <footer>
      <button class="button ghost" id="regenScene">AI: Reroll This Scene</button>
      <button class="button ghost" id="copyPrompt" aria-label="Copy prompt to clipboard">Copy Prompt</button>
      <button class="button" id="markComplete">Mark Complete</button>
    </footer>
    
  </div>
</div>

<script>
  // Footer year
  (function(){ const y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();

  // Avatars
  const AVATAR_IMAGES = ['avatar1.png','avatar2.png','avatar3.png','avatar4.png'];

  // ===== AI CONFIG (frontend) =====
  const USE_DIRECT_OPENAI = false; // keep false in production
  const AI_PROXY_URL = 'https://grantgottlieb3-github-io.vercel.app/api/ai';
  const OPENAI_API_KEY = '';
  const OPENAI_MODEL   = 'openai/gpt-oss-20b:free';

  async function callAI(systemPrompt, userPrompt, temperature = 0.8) {
    try {
      if (USE_DIRECT_OPENAI) {
        const r = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: OPENAI_MODEL || 'openai/openai/gpt-oss-20b:free',
            temperature,
            response_format: { type: 'json_object' },
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user',   content: userPrompt }
            ]
          })
        });
        const data = await r.json().catch(() => ({}));
        const raw  = data?.choices?.[0]?.message?.content ?? '';
        console.log('AI raw response (direct):', raw);
        if (!r.ok) { console.error('OpenAI error', r.status, data); return null; }
        return safeParseJSON(raw);
      } else {
        const payload = { system: systemPrompt, user: userPrompt, temperature, provider: 'openrouter', model: 'openai/gpt-oss-20b:free' };
        const r = await fetch(AI_PROXY_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const text = await r.text();
        console.log('AI raw response (proxy):', text);
        if (!r.ok) { console.error('Proxy error', r.status, text); return null; }

        let top;
        try { top = JSON.parse(text); } catch {}

        if (top && typeof top === 'object' && (top.title || top.brief || top.role || top.setting || top.key || top.goal)) {
          return top;
        }
        const content = top?.choices?.[0]?.message?.content;
        if (typeof content === 'string') {
          const inner = safeParseJSON(content);
          if (inner) return inner;
        }
        if (typeof top === 'string') {
          const inner = safeParseJSON(top);
          if (inner) return inner;
        }
        return safeParseJSON(text);
      }
    } catch (e) {
      console.error('AI error', e);
      return null;
    }
  }

  // tolerant JSON extractor (handles ```json fences, prose, etc.)
  function safeParseJSON(s) {
    if (!s) return null;
    const fence = s.match(/```(?:json)?\s*([\s\S]*?)```/i);
    if (fence) s = fence[1].trim();
    const i = s.indexOf('{'), j = s.lastIndexOf('}');
    if (i !== -1 && j !== -1 && j > i) s = s.slice(i, j + 1);
    try { return JSON.parse(s); } catch { return null; }
  }

  // ===== STATE / PERSISTENCE =====
  const STORE = {
    langKey: 'spanish_app_lang',
    cityKey: 'spanish_app_city',
    levelKey: 'spanish_app_level',
    listsKey: 'spanish_app_lists_v2',
    logKey:   'spanish_app_log',
    xpKey:    'spanish_app_xp',
    streakKey:'spanish_app_streak'
  };

  const langSel  = document.getElementById('langSel');
  const citySel  = document.getElementById('citySel');
  const levelSel = document.getElementById('levelSel');

  langSel.value  = localStorage.getItem(STORE.langKey)  || 'Spanish';
  citySel.value  = localStorage.getItem(STORE.cityKey)  || 'Madrid';
  levelSel.value = localStorage.getItem(STORE.levelKey) || 'B1';

  langSel.addEventListener('change', () => { localStorage.setItem(STORE.langKey, langSel.value); regenerateSeeds(); });
  citySel.addEventListener('change', () => { localStorage.setItem(STORE.cityKey, citySel.value); regenerateSeeds(); });
  levelSel.addEventListener('change', () => { localStorage.setItem(STORE.levelKey, levelSel.value); regenerateSeeds(); });

  function getXP(){ return +(localStorage.getItem(STORE.xpKey) || 0); }
  function setXP(v){ localStorage.setItem(STORE.xpKey, String(v)); }
  function getStreak(){
    try { return JSON.parse(localStorage.getItem(STORE.streakKey) || '{"count":0,"last":""}'); }
    catch { return {count:0, last:""}; }
  }
  function setStreak(obj){ localStorage.setItem(STORE.streakKey, JSON.stringify(obj)); }
  function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

  function getLog(){
    try { return JSON.parse(localStorage.getItem(STORE.logKey) || '[]'); }
    catch { return []; }
  }
  function addLogEntry(entry){
    const log = getLog(); log.push(entry);
    localStorage.setItem(STORE.logKey, JSON.stringify(log));
  }
  function recentHistory(category, n=3){ return getLog().filter(x => x.category === category).slice(-n); }

  const categories = ['travel','food','daily','culture','social','custom'];
  let lists = loadLists();
  function loadLists() {
    try { return JSON.parse(localStorage.getItem(STORE.listsKey) || '{"travel":[],"food":[],"daily":[],"culture":[],"social":[],"custom":[]}'); }
    catch { return { travel:[], food:[], daily:[], culture:[], social:[], custom:[] }; }
  }
  function saveLists(){ localStorage.setItem(STORE.listsKey, JSON.stringify(lists)); }

  // ===== HUD =====
  const hud = {
    xpVal: document.getElementById('xpVal'),
    xpBar: document.getElementById('xpBar'),
    streakVal: document.getElementById('streakVal'),
    counts: {
      travel: document.getElementById('c-travel'),
      food: document.getElementById('c-food'),
      daily: document.getElementById('c-daily'),
      culture: document.getElementById('c-culture'),
      social: document.getElementById('c-social'),
      custom: document.getElementById('c-custom'),
    }
  };

  function updateHUD(){
    const xp = getXP();
    hud.xpVal.textContent = xp;
    const pct = Math.min(100, ((xp % 500) / 500) * 100);
    hud.xpBar.style.width = pct + '%';

    const st = getStreak();
    hud.streakVal.textContent = `${st.count} day${st.count===1?'':'s'}`;

    const byCat = {travel:0,food:0,daily:0,culture:0,social:0,custom:0};
    getLog().forEach(x => { if(byCat[x.category] !== undefined) byCat[x.category]++; });
    Object.keys(byCat).forEach(k => { hud.counts[k].textContent = byCat[k]; });
  }

  function awardCompletion(category){
    setXP(getXP() + 50);
    const st = getStreak();
    const t  = todayStr();
    if (!st.last) { setStreak({count:1, last:t}); }
    else if (st.last !== t) {
      const prev = new Date(st.last), now  = new Date();
      const diffDays = Math.round((now - prev) / 86400000);
      setStreak({count: diffDays === 1 ? (st.count + 1) : 1, last: t});
    }
    updateHUD();
  }

  // ===== RENDERING =====
  const containers = {
    travel:  document.getElementById('list-travel'),
    food:    document.getElementById('list-food'),
    daily:   document.getElementById('list-daily'),
    culture: document.getElementById('list-culture'),
    social:  document.getElementById('list-social'),
    custom:  document.getElementById('list-custom')
  };

  // Track which scene tab is active (default: Travel)
  let activeSceneTab = document.querySelector('#scenes .tab-btn.active')?.dataset.tab || 'travel';

  // Only generate AI content when:
  // - Scenes view is visible, AND
  // - The category is the active scene tab
  function shouldGenerate(category){
    const scenesActive = viewPanels.scenes.classList.contains('active');
    return scenesActive && category === activeSceneTab;
  }

  function renderAll() {
    // Only render (and potentially generate) the active scene tab to limit usage
    renderCategory(activeSceneTab, true);
    updateHUD();
  }

  function renderCategory(category, allowAI = true) {
    const root = containers[category];
    if (!root) return;
    root.innerHTML = '';
    const arr = lists[category] || [];

    if (!arr.length && category !== 'custom') {
      if (shouldGenerate(category) && allowAI) {
        const ld = document.createElement('article');
        ld.className = 'card scene-card';
        ld.innerHTML = `<div class="content"><h4>Generating ${capitalize(category)} scene <span class="spinner" aria-hidden="true"></span></h4><p class="muted">Tailoring to ${citySel.value}…</p></div>`;
        root.appendChild(ld);
        aiSeedCategory(category);
      }
      return;
    }

    arr.forEach(item => { root.appendChild(renderSceneCard(item)); });
  }

  function renderSceneCard(scn) {
    const el = document.createElement('article');
    el.className = 'card scene-card';
    el.innerHTML = `
      <div class="content">
        <h4>${scn.title}</h4>
        <p>${scn.brief}</p>
        <div class="actions" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="button ghost" data-act="details" data-id="${scn.id}" data-cat="${scn.category}">Details</button>
        </div>
      </div>
    `;
    return el;
  }

  // ===== TABS =====
  // TOP-LEVEL VIEW TABS (Profile vs Scenes)
  const viewButtons = document.querySelectorAll('[data-view]');
  const viewPanels = {
    profile: document.getElementById('view-profile'),
    scenes:  document.getElementById('view-scenes')
  };

  viewButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      viewButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      Object.values(viewPanels).forEach(p => p.classList.remove('active'));
      viewPanels[btn.dataset.view].classList.add('active');

      if (btn.dataset.view === 'scenes') {
        renderCategory(activeSceneTab, true);
      }
    });
  });

  // SCENE CATEGORY TABS (scoped to #scenes only)
  document.querySelectorAll('#scenes .tab-btn[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      activeSceneTab = btn.dataset.tab;

      document.querySelectorAll('#scenes .tab-btn[data-tab]').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#scenes .tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('panel-' + activeSceneTab).classList.add('active');

      renderCategory(activeSceneTab, true);
    });
  });

  // ===== MODAL =====
  const modal = document.getElementById('modal');
  const closeModalBtn = document.getElementById('closeModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalRole = document.getElementById('modalRole');
  const modalSetting = document.getElementById('modalSetting');
  const modalKey = document.getElementById('modalKey');
  const modalAvatar = document.getElementById('modalAvatar');
  const modalNotes = document.getElementById('modalNotes');
  const regenBtn = document.getElementById('regenScene');
  const completeBtn = document.getElementById('markComplete');
  const copyBtn = document.getElementById('copyPrompt');

  let current = null;

  function openModal(scn) {
    current = scn;
    modalTitle.textContent = scn.title;
    modalRole.textContent = scn.role || 'Conversation partner';
    modalSetting.textContent = scn.setting || '(AI-generated setting)';
    modalKey.innerHTML = Array.isArray(scn.key) && scn.key.length
      ? `<ul style="margin:0 0 0 18px;">${scn.key.map(k=>`<li>${k}</li>`).join('')}</ul>`
      : '<span class="muted">Key points will be generated by AI.</span>';
    modalNotes.value = '';
    const pick = AVATAR_IMAGES[Math.floor(Math.random() * AVATAR_IMAGES.length)];
    modalAvatar.innerHTML = `<img src="${pick}" alt="Conversation partner avatar" class="avatar-img" loading="lazy">`;
    modal.classList.add('open');
  }
  function closeModal(){ modal.classList.remove('open'); current = null; }
  closeModalBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  document.getElementById('scenes').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-act="details"]');
    if (!btn) return;
    const cat = btn.getAttribute('data-cat');
    const id  = btn.getAttribute('data-id');
    const scn = (lists[cat] || []).find(s => s.id === id);
    if (scn) openModal(scn);
  });

  regenBtn.addEventListener('click', async () => {
    if (!current) return;
    regenBtn.disabled = true; regenBtn.textContent = 'Re-rolling…';
    const repl = await aiGenerateScene(current.category);
    if (repl) {
      const arr = lists[current.category];
      const idx = arr.findIndex(x => x.id === current.id);
      if (idx !== -1) { arr[idx] = repl; saveLists(); renderCategory(current.category); openModal(repl); }
    }
    regenBtn.disabled = false; regenBtn.textContent = 'AI: Reroll This Scene';
  });

  completeBtn.addEventListener('click', async () => {
    if (!current) return;
    const cat = current.category;
    const notes = modalNotes.value.trim();

    addLogEntry({ ts: Date.now(), category: cat, title: current.title, notes });
    awardCompletion(cat);
    closeModal();

    const placeholder = {
      id: `${cat}-loading-${Date.now()}`, category: cat,
      title: 'Generating next scenario…',
      brief: `Asking AI to continue your ${capitalize(cat)} storyline for ${citySel.value} <span class="spinner"></span>`,
      role: '', setting: '', key: []
    };
    lists[cat].push(placeholder); saveLists(); renderCategory(cat);

    const next = await aiGenerateNextScene(cat, current);
    const arr = lists[cat];
    const pIdx = arr.findIndex(x => x.id === placeholder.id);
    if (next && pIdx !== -1) { arr[pIdx] = next; saveLists(); renderCategory(cat); }
  });

  // === Build conversation-bot prompt from the AI scene (popup info) ===
  function buildConversationBotPrompt(scn){
    const lang  = langSel.value;
    const level = levelSel.value;
    const city  = citySel.value;

    const keyLines = Array.isArray(scn.key) && scn.key.length
      ? scn.key.map(k => `  - ${k}`).join('\n')
      : '  - (none)';

    const role = scn.role || 'Conversation partner';
    const setting = scn.setting || city;
    const goal = (scn.goal && scn.goal.trim()) ? scn.goal : 'Help the participant complete a realistic task.';

    return (
`You are a ${lang} aid for a ${level} speaker for an immersion game in ${city}. Please ensure that in the following conversation you utilize a level of ${lang} that someone at this level (${level}) could understand. Incorporate colloquial expressions and an accent of someone native to ${city}.

Here is your role and context:
- Your role: ${role}
- Setting: ${setting}
- Key information:
${keyLines}
- Conversation goal: ${goal}

IMPORTANT, remember to speak at a comprehensible manner to a learner at this level ${level}. The conversation should be a back and forth, make sure to keep a natural flow. Keep your responses brief (1-2 sentences). Once the participant has achieved the goal of the conversation, tell them it is complete and provide some brief, simple feedback on the conversation. Acknowledge this message but do not start the role play until the participant speaks.`).trim();
  }

  // Copy Prompt button: copies the conversation-bot prompt (built from current scene)
  copyBtn.addEventListener('click', async () => {
    if (!current) return;

    const clip = buildConversationBotPrompt(current);

    try {
      await navigator.clipboard.writeText(clip);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = clip;
      ta.setAttribute('readonly', '');
      ta.style.position = 'absolute';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }

    const original = copyBtn.textContent;
    copyBtn.textContent = 'Copied!';
    copyBtn.disabled = true;
    setTimeout(() => {
      copyBtn.textContent = original;
      copyBtn.disabled = false;
    }, 1200);
  });

  // ===== AI SCENE GENERATION =====
  function baseSystemPrompt(){
    return `You generate city-specific conversation scenes for a Spanish immersion app.
Output JSON only, matching:
{
  "title": "string",
  "brief": "1–2 sentence description",
  "role": "who the learner is talking to",
  "setting": "where it happens (city-specific)",
  "key": ["3–5 bullet points"],
  "goal": "clear outcome to reach"
}
Rules:
- Use the selected City (Spain), Language and CEFR Level.
- If city lacks an airport (e.g., Torrevieja), route via nearest major airport then realistic transport.
- Keep details plausible for that city (transit, barrios, customs, hours).
- Avoid fragile facts; prefer generic but city-colored details.
- Titles short; "key" items actionable.
- Do not include prose or code fences—JSON only.
- Return ONLY a single JSON object. No markdown fences, no prose, no explanations.
- Property names must be exactly: title, brief, role, setting, key (array), goal.
`;
  }

  function seedUserPrompt(category){
    const lang  = langSel.value;
    const city  = citySel.value;
    const level = levelSel.value;
    const label = capitalize(category);
    return `Language: ${lang}
City: ${city}
CEFR level: ${level}
Category: ${label}
Task: Propose the very first practice scene a newcomer would realistically face in this category in ${city}. Make it authentic to ${city}.`;
  }

  function nextUserPrompt(category, lastScene){
    const lang  = langSel.value;
    const city  = citySel.value;
    const level = levelSel.value;
    const history = recentHistory(category, 3)
      .map(x => `- ${x.title}${x.notes?`: ${x.notes}`:''}`)
      .join('\n') || '(none)';

    return `Language: ${lang}

City: ${city}
CEFR level: ${level}
Category: ${capitalize(category)}
Last scene JSON:
${JSON.stringify(stripId(lastScene), null, 2)}
Recent outcomes in this category:
${history}
Task: Propose the next logical scene that builds difficulty slightly and stays authentic to ${city}.`;
  }

  function stripId(obj){
    if (!obj || typeof obj !== 'object') return {};
    const { id, category, ...rest } = obj;
    return rest;
  }

  async function aiSeedCategory(category){
    const scene = await aiGenerateScene(category);
    if (scene) {
      lists[category] = [scene]; saveLists(); renderCategory(category, false);
    } else {
      lists[category] = [{
        id: `${category}-fallback`,
        category,
        title: `${capitalize(category)} — Manual Start`,
        brief: `Couldn’t reach AI. Click Details and use your own idea to begin.`,
        role: 'Local person',
        setting: `${citySel.value}`,
        key: ['Set a clear goal', 'Keep turns short', 'Ask follow-ups'],
        goal: 'Have a short, realistic chat'
      }];
      saveLists(); renderCategory(category, false);
    }
  }

  async function aiGenerateScene(category){
    const sys = baseSystemPrompt();
    const usr = seedUserPrompt(category);
    const obj = await callAI(sys, usr, 0.9);
    if (!obj) return null;
    return normalizeScene(obj, category);
  }

  async function aiGenerateNextScene(category, lastScene){
    const sys = baseSystemPrompt();
    const usr = nextUserPrompt(category, lastScene);
    const obj = await callAI(sys, usr, 0.9);
    if (!obj) return null;
    return normalizeScene(obj, category);
  }

  function normalizeScene(obj, category){
    if (!obj || typeof obj !== 'object') obj = {};
    const title  = (obj.title || obj.name || 'Scene').toString().slice(0, 120);
    const brief  = (obj.brief || obj.description || obj.summary || '').toString().slice(0, 240);
    const role   = (obj.role || obj.partner || obj.character || 'Conversation partner').toString().slice(0, 120);
    const setting = (obj.setting || obj.location || obj.place || citySel.value || '').toString().slice(0, 200);

    let key = obj.key || obj.keys || obj.points || obj.bullets || obj.topics || [];
    if (typeof key === 'string') {
      key = key.split(/\r?\n|•|-/).map(s => s.trim()).filter(Boolean);
    }
    if (!Array.isArray(key)) key = [];
    key = key.slice(0,5).map(x => x.toString().slice(0,120));

    const goal = (obj.goal || obj.objective || obj.target || '').toString().slice(0, 160);

    return {
      id: `${category}-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,
      category, title, brief, role, setting, key, goal
    };
  }

  async function regenerateSeeds(){
    lists = { travel:[], food:[], daily:[], culture:[], social:[], custom:[] };
    saveLists();
    renderAll();
  }

  // ===== CUSTOM SCENES =====
  document.getElementById('addCustom').addEventListener('click', async () => {
    const kw = (document.getElementById('customKeyword').value || '').trim();
    if (!kw) { alert('Please enter a keyword.'); return; }
    const sys = baseSystemPrompt();
    const usr = `${seedUserPrompt('custom')}

Extra requirement: Build the first scene around this keyword: "${kw}".`;
    const obj = await callAI(sys, usr, 0.9);
    const scn = obj ? normalizeScene(obj, 'custom') : {
      id:`custom-${Date.now()}`, category:'custom',
      title:`Custom: ${capitalize(kw)}`, brief:`Practice focused on “${kw}” in ${citySel.value}.`,
      role:'Local person', setting: citySel.value,
      key:['Define your goal','Ask relevant questions','Summarize outcome'], goal:'Make clear progress'
    };
    lists.custom.push(scn); saveLists(); renderCategory('custom', false);
    document.getElementById('customKeyword').value = '';
  });

  // ===== BOOTSTRAP =====
  renderAll();

  // ===== UTIL =====
  function capitalize(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
</script>
</body>
</html>
