<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>$imple Budget Sheet</title>

  <!-- Use your provided CSS as-is -->
  <link rel="stylesheet" href="styles.css" />

  <!-- iOS Add-to-Home-Screen touch-icon (optional) -->
  <link rel="apple-touch-icon" href="icon.png" />
</head>
<body>
  <!-- Smaller sticky header -->
  <header class="header">
    <div class="container nav" style="padding:8px 0;"> <!-- reduced from 14px -->
      <div class="brand" style="font-size:16px;"></div>
      <nav class="right tabs view-tabs" role="tablist" aria-label="Primary">
        <button id="tab-budget" class="button ghost tab-btn" aria-selected="true" onclick="UI.switchTab('budget')">Budget</button>
        <button id="tab-profile" class="button ghost tab-btn" aria-selected="false" onclick="UI.switchTab('profile')">Profile</button>
      </nav>
    </div>
  </header>

  <main class="container" id="app" style="padding-bottom: 32px;">

    <!-- ============ BUDGET VIEW ============ -->
    <section id="view-budget" role="tabpanel" aria-labelledby="tab-budget">
      <div class="section-title" style="margin-top:8px;">
        <h2>Monthly Budget</h2>
        <div class="line"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="button ghost" title="Prev month" onclick="Budget.shiftMonth(-1)">◀</button>
          <span class="badge" id="monthLabel">—</span>
          <button class="button ghost" title="Next month" onclick="Budget.shiftMonth(1)">▶</button>
        </div>
      </div>

      <!-- Bin summaries (tap a card to add expense) -->
      <div class="grid cols-3" id="binsSummary"></div>

      <!-- Expense list -->
      <section class="card" style="padding:16px; margin-top:16px;">
        <div class="section-title" style="margin:0 0 8px;">
          <h2>Expenses</h2>
          <div class="line"></div>
        </div>
        <div id="expenseList" class="grid"></div>
        <p id="noExpenses" class="badge" style="margin-top:8px; display:none;">No expenses yet this month.</p>
      </section>
    </section>

    <!-- ============ PROFILE VIEW ============ -->
    <section id="view-profile" role="tabpanel" aria-labelledby="tab-profile" hidden>
        <div class="section-title">
            <h2>Overall Stats</h2>
            <div class="line"></div>
          </div>
          <section class="card" style="padding:16px;">
            <div id="overallStats" class="grid cols-3"></div>
          </section>

      <div class="section-title">
        <h2>Budget Bins</h2>
        <div class="line"></div>
      </div>
      
      <section class="card" style="padding:16px;">
        <!-- Bin list -->
        <div id="binList" class="grid" style="gap:12px;">
          <!-- Each bin will be injected here by Profile.renderBins() -->
        </div>
      
        <!-- Add new bin row -->
        <div class="grid" style="margin-top:16px; grid-template-columns: 1fr 1fr auto; gap:8px;">
          <input id="newBinName"
                 type="text"
                 placeholder="New bin (e.g., Rent)"
                 style="font-size:16px; padding:12px; border:1px solid var(--border);
                        border-radius:12px; background:var(--card); width:100%;" />
          <input id="newBinAmt"
                 type="number"
                 inputmode="decimal"
                 step="0.01"
                 placeholder="Amount / month (EUR)"
                 style="font-size:16px; padding:12px; border:1px solid var(--border);
                        border-radius:12px; background:var(--card); width:100%;" />
          <button class="button secondary" style="font-size:16px; padding:12px 18px;"
                  onclick="Profile.addBin()">Add</button>
        </div>
      
        <p class="badge" style="margin-top:12px; font-size:13px;">
          Bins are stored in EUR; display uses your chosen currency and FX.
        </p>
      </section>
      

      <div class="section-title">
        <h2>Profile</h2>
        <div class="line"></div>
      </div>

      <section class="card" style="padding:16px;">
        <div class="grid cols-3">
          <div>
            <label class="badge" for="stipend">Monthly stipend (EUR)</label>
            <input id="stipend" type="number" inputmode="decimal" step="0.01" placeholder="1000" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
          <div>
            <label class="badge" for="currency">Display currency</label>
            <select id="currency" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);">
              <option value="EUR">EUR (€)</option>
              <option value="USD">USD ($)</option>
            </select>
          </div>
          <div>
            <label class="badge" for="fx">EUR → USD rate</label>
            <input id="fx" type="number" inputmode="decimal" step="0.0001" placeholder="1.08" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
        </div>
        <div class="grid cols-2" style="margin-top:12px;">
          <div>
            <label class="badge" for="startMonth">Starting month</label>
            <input id="startMonth" type="month" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="button" onclick="Profile.save()">Save</button>
            <button class="button ghost" onclick="App.resetAll()">Reset All</button>
            <span id="saveNote" class="badge" style="border-style:dashed;"> </span>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- ========== SIMPLE ADD EXPENSE DIALOG ========== -->
  <dialog id="addDialog" style="border:none; border-radius:16px; max-width:560px; width:92vw; padding:0;">
    <form method="dialog" class="card" style="padding:16px; margin:0;">
      <div class="section-title" style="margin:0 0 8px;">
        <h2 id="dlgTitle">Add Expense</h2>
        <div class="line"></div>
        <button class="button ghost" value="cancel">Close</button>
      </div>
      <div class="grid cols-2">
        <div>
          <label class="badge">Name</label>
          <input id="dlgName" type="text" placeholder="e.g., Groceries" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
        </div>
        <div>
          <label class="badge">Amount (<span id="dlgCur">€</span>)</label>
          <input id="dlgAmt" type="number" inputmode="decimal" step="0.01" placeholder="0.00" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="button" onclick="Budget.saveDialog(event)">Save</button>
        <button class="button ghost" value="cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- ==================== APP SCRIPT ==================== -->
  <script>
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // ---------- App State ----------
  const App = {
    key: 'nalcap_budget_v3_simple',
    state: null,
    defaultState(){
      const now = new Date();
      const ym = Util.fmtYM(now);
      return {
        settings: { stipendEUR: 1000, currency: 'EUR', fx: 1.08, startMonth: ym },
        bins: [
          { id: Util.id(), name: 'Rent', monthlyEUR: 500 },
          { id: Util.id(), name: 'Groceries', monthlyEUR: 200 },
          { id: Util.id(), name: 'Transport', monthlyEUR: 80 },
        ],
        expenses: { } // { 'YYYY-MM': [ {id, date, binId, name, amountEUR} ] }
      };
    },
    load(){
      try { const raw = localStorage.getItem(this.key); this.state = raw ? JSON.parse(raw) : this.defaultState(); }
      catch { this.state = this.defaultState(); }
    },
    save(){ localStorage.setItem(this.key, JSON.stringify(this.state)); },
    resetAll(){ if(!confirm('Reset all data?')) return; localStorage.removeItem(this.key); location.reload(); }
  };

  // ---------- Utilities ----------
  const Util = {
    id: () => Math.random().toString(36).slice(2,9),
    fmtYM: (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,
    labelYM(ym){ const [y,m]=ym.split('-').map(Number); return new Date(y, m-1, 1).toLocaleString(undefined,{month:'long', year:'numeric'}); },
    ensureMonth(ym){ const S=App.state; if(!S.expenses[ym]) S.expenses[ym]=[]; },
    eurToDisp(eur){ const {currency,fx} = App.state.settings; return currency==='EUR'? eur : eur*fx; },
    dispToEur(n){ const {currency,fx} = App.state.settings; return currency==='EUR'? n : n/fx; },
    money(n){ const cur=App.state.settings.currency==='EUR'?'EUR':'USD'; return new Intl.NumberFormat(undefined,{style:'currency',currency:cur, maximumFractionDigits:2}).format(n); },
  };

  // ---------- Tabs & Rendering ----------
  const UI = {
    currentYM: null,
    switchTab(name){
      const budget = $('#view-budget');
      const profile = $('#view-profile');
      const tb = $('#tab-budget');
      const tp = $('#tab-profile');
      const isBudget = name==='budget';
      budget.hidden = !isBudget; profile.hidden = isBudget;
      tb.setAttribute('aria-selected', isBudget); tp.setAttribute('aria-selected', !isBudget);
      if(isBudget) Budget.render(); else Profile.render();
    }
  };

  // ---------- Profile Logic ----------
  const Profile = {
    render(){
      const S = App.state;
      $('#stipend').value = S.settings.stipendEUR;
      $('#currency').value = S.settings.currency;
      $('#fx').value = S.settings.fx;
      $('#startMonth').value = S.settings.startMonth;
      this.renderBins();
      this.renderOverall();
    },
    save(){
      const S = App.state;
      S.settings.stipendEUR = parseFloat($('#stipend').value||'1000');
      S.settings.currency  = $('#currency').value;
      S.settings.fx        = parseFloat($('#fx').value||'1.08');
      S.settings.startMonth= $('#startMonth').value || Util.fmtYM(new Date());
      App.save();
      $('#saveNote').textContent = 'Saved ✓'; setTimeout(()=>$('#saveNote').textContent=' ', 1200);
      Budget.render(); this.renderBins(); this.renderOverall();
    },
    renderBins(){
      const host = $('#binList'); host.innerHTML='';
      App.state.bins.forEach(b=>{
        const card = document.createElement('div'); card.className='card item';
        card.innerHTML = `
          <div style="flex:1">
            <div style="display:grid; grid-template-columns: 1fr 140px auto; gap:8px; align-items:center;">
              <input data-k="name" data-id="${b.id}" type="text" value="${b.name}" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
              <input data-k="amount" data-id="${b.id}" type="number" inputmode="decimal" step="0.01" value="${b.monthlyEUR}" style="padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
              <div style="display:flex; gap:6px;">
                <button class="button ghost" onclick="Profile.dupBin('${b.id}')">Duplicate</button>
                <button class="button ghost" onclick="Profile.delBin('${b.id}')">Delete</button>
              </div>
            </div>
            <div class="meta">EUR/mo</div>
          </div>`;
        host.appendChild(card);
      });
      $$('#binList input[data-k]').forEach(inp=>{
        inp.addEventListener('change', (e)=>{
          const id = e.target.dataset.id; const k = e.target.dataset.k; const bin = App.state.bins.find(x=>x.id===id); if(!bin) return;
          if(k==='name') bin.name=e.target.value; else bin.monthlyEUR=parseFloat(e.target.value||'0');
          App.save(); Budget.render(); Profile.renderOverall();
        });
      });
    },
    addBin(){
      const name = $('#newBinName').value.trim(); const amt = parseFloat($('#newBinAmt').value||'0');
      if(!name) return alert('Enter a bin name');
      App.state.bins.push({id:Util.id(), name, monthlyEUR:amt});
      $('#newBinName').value=''; $('#newBinAmt').value='';
      App.save(); this.renderBins(); Budget.render(); this.renderOverall();
    },
    delBin(id){ if(!confirm('Delete this bin?')) return; App.state.bins = App.state.bins.filter(b=>b.id!==id); App.save(); this.renderBins(); Budget.render(); this.renderOverall(); },
    dupBin(id){ const b=App.state.bins.find(x=>x.id===id); if(!b) return; App.state.bins.push({id:Util.id(), name:b.name+' (copy)', monthlyEUR:b.monthlyEUR}); App.save(); this.renderBins(); },
    renderOverall(){
  const host = $('#overallStats'); host.innerHTML='';
  const totalBudgetEUR = App.state.bins.reduce((s,b)=>s+b.monthlyEUR,0);

  // Sum all-time spent
  let totalSpentEUR = 0;
  Object.values(App.state.expenses).forEach(list => {
    list.forEach(e => totalSpentEUR += e.amountEUR);
  });

  // Active months = number of months with any expenses recorded
  const totalMonths = Object.keys(App.state.expenses).length;

  // Monthly stipend (EUR)
  const stipendPerMonthEUR = App.state.settings.stipendEUR || 0;

  // Income across active months, and Net = Income - Spent
  const totalIncomeEUR = totalMonths * stipendPerMonthEUR;
  const netEUR = totalIncomeEUR - totalSpentEUR;

  const makeStat = (label,val) =>
    `<div class="card" style="padding:16px;">
       <div class="meta">${label}</div>
       <div style="font-size:20px; font-weight:700;">${val}</div>
     </div>`;

  host.innerHTML = [
    makeStat('Monthly Budget', Util.money(Util.eurToDisp(totalBudgetEUR))),
    makeStat('Total Spent (all time)', Util.money(Util.eurToDisp(totalSpentEUR))),
    makeStat('Net Total', Util.money(Util.eurToDisp(netEUR)))
  ].join('');
}

  };

  // ---------- Budget Logic ----------
  const Budget = {
    pendingBinId: null,
    shiftMonth(delta){
      const [y,m] = UI.currentYM.split('-').map(Number);
      const d = new Date(y, m-1+delta, 1);
      UI.currentYM = Util.fmtYM(d);
      this.render();
    },
    openDialog(binId){
      this.pendingBinId = binId;
      $('#dlgTitle').textContent = 'Add to ' + (App.state.bins.find(b=>b.id===binId)?.name || 'Bin');
      $('#dlgCur').textContent = App.state.settings.currency==='EUR' ? '€' : '$';
      $('#dlgName').value = '';
      $('#dlgAmt').value = '';
      $('#addDialog').showModal();
      setTimeout(()=>$('#dlgName').focus(), 50);
    },
    saveDialog(ev){
      ev.preventDefault();
      const name = $('#dlgName').value.trim();
      const amtDisp = parseFloat($('#dlgAmt').value||'0');
      if(!name || !(amtDisp>0)) { $('#addDialog').close(); return; }
      Util.ensureMonth(UI.currentYM);
      const amountEUR = Util.dispToEur(amtDisp);
      const today = new Date().toISOString().slice(0,10);
      App.state.expenses[UI.currentYM].push({id:Util.id(), date:today, binId:this.pendingBinId, name, amountEUR});
      App.save(); $('#addDialog').close(); this.render(); Profile.renderOverall();
    },
    editExpense(expId){
      const arr = App.state.expenses[UI.currentYM]; const i = arr.findIndex(e=>e.id===expId); if(i<0) return;
      const e = arr[i];
      const newName = prompt('Name', e.name||''); if(newName===null) return; e.name=newName;
      const newAmt  = prompt('Amount ('+(App.state.settings.currency==='EUR'?'€':'$')+')', Util.eurToDisp(e.amountEUR).toFixed(2)); if(newAmt===null) return; e.amountEUR = Util.dispToEur(parseFloat(newAmt||'0'));
      App.save(); this.render(); Profile.renderOverall();
    },
    delExpense(expId){ if(!confirm('Delete expense?')) return; const arr=App.state.expenses[UI.currentYM]; const i=arr.findIndex(e=>e.id===expId); if(i>=0){ arr.splice(i,1); App.save(); this.render(); Profile.renderOverall(); } },
    render(){
      const S = App.state;
      if(!UI.currentYM) UI.currentYM = S.settings.startMonth || Util.fmtYM(new Date());
      Util.ensureMonth(UI.currentYM);
      $('#monthLabel').textContent = Util.labelYM(UI.currentYM);

      // Bin cards
    const totals = {}; 
    S.bins.forEach(b => totals[b.id] = 0);
    App.state.expenses[UI.currentYM].forEach(e => {
    totals[e.binId] = (totals[e.binId] || 0) + e.amountEUR;
    });
    const host = $('#binsSummary');
    host.innerHTML = '';

    S.bins.forEach(b => {
    const spent = totals[b.id] || 0;
    const budget = b.monthlyEUR || 0;
    const rem = budget - spent;
    const pct = Math.min(100, Math.max(0, budget > 0 ? (spent / budget) * 100 : 0));
    const bar = `
        <div style="height:10px; background:var(--accent-2); border-radius:999px; overflow:hidden;">
        <div style="height:100%; width:${pct}%; background:var(--accent);"></div>
        </div>`;
    const fraction = `${Util.money(Util.eurToDisp(spent))} / ${Util.money(Util.eurToDisp(budget))} spent`;
    const over = rem < 0;

    const card = document.createElement('div');
    card.className = 'card';
    card.style.padding = '14px';
    card.style.cursor = 'pointer';
    card.setAttribute('role', 'button');
    card.setAttribute('aria-label', 'Add expense to ' + b.name);
    card.onclick = () => Budget.openDialog(b.id);

    card.innerHTML = `
        <div class="item" style="padding:0; gap:10px;">
        <div style="flex:1">
            <h3 style="margin:0 0 6px;">${b.name}</h3>
            ${bar}
            <div class="meta" style="display:flex; gap:8px; margin-top:6px;">
            <span class="badge" style="border-style:${over ? 'solid' : 'dashed'}; ${over ? 'color:#b00020;' : ''}">
                ${fraction}
            </span>
            </div>
        </div>
        </div>`;
    host.appendChild(card);
    });


      // Expenses
      const list = $('#expenseList'); list.innerHTML='';
      const items = App.state.expenses[UI.currentYM];
      $('#noExpenses').style.display = items.length? 'none' : 'block';
      items.slice().reverse().forEach(e=>{
        const bin = S.bins.find(b=>b.id===e.binId);
        const row = document.createElement('div'); row.className='card item';
        row.innerHTML = `
          <div style="flex:1">
            <h3>${e.name||'(untitled)'}</h3>
            <div class="meta">${new Date(e.date).toLocaleDateString()} · ${bin?bin.name:'(bin deleted)'}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${Util.money(Util.eurToDisp(e.amountEUR))}</div>
            <div class="meta"><a href="#" onclick="Budget.editExpense('${e.id}'); return false;">Edit</a> · <a href="#" onclick="Budget.delExpense('${e.id}'); return false;">Delete</a></div>
          </div>`;
        list.appendChild(row);
      });
    }
  };

  // ---------- Init ----------
  App.load();
  UI.switchTab('budget');
  </script>
</body>
</html>
