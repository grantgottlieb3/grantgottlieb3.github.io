<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>NALCAP Budget — Mobile Web</title>

  <!-- Use your provided CSS as-is -->
  <link rel="stylesheet" href="styles.css" />

  <!-- XLSX for importing the Excel you mentioned -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- iOS Add-to-Home-Screen touch-icon (optional, can remove) -->
  <link rel="apple-touch-icon" href="icon.png" />
</head>
<body>
  <!-- Sticky header with two primary tabs -->
  <header class="header">
    <div class="container nav">
      <div class="brand">NALCAP Budget</div>
      <nav class="right tabs view-tabs" role="tablist" aria-label="Primary">
        <button id="tab-budget" class="button ghost tab-btn" aria-selected="true" onclick="UI.switchTab('budget')">Budget</button>
        <button id="tab-profile" class="button ghost tab-btn" aria-selected="false" onclick="UI.switchTab('profile')">Profile</button>
      </nav>
    </div>
  </header>

  <main class="container" id="app" style="padding-bottom: 120px;">

    <!-- ============ BUDGET VIEW ============ -->
    <section id="view-budget" role="tabpanel" aria-labelledby="tab-budget">
      <div class="section-title">
        <h2>Monthly View</h2>
        <div class="line"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="button ghost" title="Prev month" onclick="Budget.shiftMonth(-1)">◀</button>
          <span class="badge" id="monthLabel">—</span>
          <button class="button ghost" title="Next month" onclick="Budget.shiftMonth(1)">▶</button>
        </div>
      </div>

      <!-- Bin summaries -->
      <div class="grid cols-3" id="binsSummary"></div>

      <!-- Quick add expense -->
      <section class="card" style="padding:16px; margin-top:16px;">
        <div class="section-title" style="margin:0 0 10px;">
          <h2>Add Expense</h2>
          <div class="line"></div>
        </div>
        <div class="grid cols-3">
          <div>
            <label class="badge" for="qaBin">Bin</label>
            <select id="qaBin" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);"></select>
          </div>
          <div>
            <label class="badge" for="qaName">Name</label>
            <input id="qaName" type="text" placeholder="e.g., Groceries" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
          <div>
            <label class="badge" for="qaAmt">Amount (<span id="qaCurLbl">€</span>)</label>
            <input id="qaAmt" type="number" inputmode="decimal" step="0.01" placeholder="0.00" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);"/>
          </div>
        </div>
        <div class="grid cols-2" style="margin-top:12px;">
          <div>
            <label class="badge" for="qaDate">Date</label>
            <input id="qaDate" type="date" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="button" onclick="Budget.saveQuickAdd()">Add</button>
            <button class="button ghost" onclick="Budget.clearQuickAdd()">Clear</button>
          </div>
        </div>
      </section>

      <!-- Expense list -->
      <section class="card" style="padding:16px; margin-top:16px;">
        <div class="section-title" style="margin:0 0 8px;">
          <h2>Expenses</h2>
          <div class="line"></div>
          <button class="button ghost" onclick="IO.exportCSV()">Export CSV</button>
          <button class="button ghost" onclick="IO.exportJSON()">Export JSON</button>
        </div>
        <div id="expenseList" class="grid"></div>
        <p id="noExpenses" class="badge" style="margin-top:8px; display:none;">No expenses yet this month.</p>
      </section>

      <!-- Import from Excel/CSV -->
      <section class="card" style="padding:16px; margin-top:16px;">
        <div class="section-title" style="margin:0 0 8px;">
          <h2>Import</h2>
          <div class="line"></div>
        </div>
        <div class="grid cols-2">
          <div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
          </div>
          <div style="display:flex; gap:8px;">
            <button class="button secondary" onclick="IO.openMapper()">Map Columns</button>
            <button class="button ghost" onclick="IO.copyData()">Copy Data</button>
          </div>
        </div>
        <p class="badge" style="margin-top:8px;">Expected columns (auto-detected or map manually): <code class="inline">date</code>, <code class="inline">bin</code> (or <code class="inline">category</code>), <code class="inline">name</code>, <code class="inline">amount</code>, <code class="inline">currency</code>.</p>
        <div id="mapper" style="display:none; margin-top:10px;">
          <div class="grid cols-3">
            <div><label class="badge">Date</label><select id="map-date"></select></div>
            <div><label class="badge">Bin</label><select id="map-bin"></select></div>
            <div><label class="badge">Name</label><select id="map-name"></select></div>
          </div>
          <div class="grid cols-3" style="margin-top:8px;">
            <div><label class="badge">Amount</label><select id="map-amount"></select></div>
            <div><label class="badge">Currency</label><select id="map-currency"></select></div>
            <div style="display:flex; align-items:flex-end;"><button class="button" onclick="IO.applyMapping()">Import</button></div>
          </div>
        </div>
      </section>
    </section>

    <!-- ============ PROFILE VIEW ============ -->
    <section id="view-profile" role="tabpanel" aria-labelledby="tab-profile" hidden>
      <div class="section-title">
        <h2>Profile</h2>
        <div class="line"></div>
      </div>

      <section class="card" style="padding:16px;">
        <div class="grid cols-3">
          <div>
            <label class="badge" for="stipend">Monthly stipend (EUR)</label>
            <input id="stipend" type="number" inputmode="decimal" step="0.01" placeholder="1000" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
          <div>
            <label class="badge" for="currency">Display currency</label>
            <select id="currency" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);">
              <option value="EUR">EUR (€)</option>
              <option value="USD">USD ($)</option>
            </select>
          </div>
          <div>
            <label class="badge" for="fx">EUR → USD rate</label>
            <input id="fx" type="number" inputmode="decimal" step="0.0001" placeholder="1.08" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
        </div>
        <div class="grid cols-2" style="margin-top:12px;">
          <div>
            <label class="badge" for="startMonth">Starting month</label>
            <input id="startMonth" type="month" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="button" onclick="Profile.save()">Save</button>
            <button class="button ghost" onclick="App.resetAll()">Reset All</button>
            <span id="saveNote" class="badge" style="border-style:dashed;"> </span>
          </div>
        </div>
      </section>

      <div class="section-title">
        <h2>Budget Bins</h2>
        <div class="line"></div>
      </div>
      <section class="card" style="padding:16px;">
        <div id="binList" class="grid"></div>
        <div class="grid cols-3" style="margin-top:12px;">
          <input id="newBinName" type="text" placeholder="New bin (e.g., Rent)" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          <input id="newBinAmt" type="number" inputmode="decimal" step="0.01" placeholder="Amount / month (EUR)" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
          <button class="button secondary" onclick="Profile.addBin()">Add Bin</button>
        </div>
        <p class="badge" style="margin-top:10px;">Bins are stored in EUR; display uses your chosen currency and FX.</p>
      </section>

      <div class="section-title">
        <h2>Overall Stats</h2>
        <div class="line"></div>
      </div>
      <section class="card" style="padding:16px;">
        <div id="overallStats" class="grid cols-3"></div>
      </section>
    </section>
  </main>

  <!-- Bottom actions for quick access on iOS -->
  <footer class="footer" style="position:fixed; left:0; right:0; bottom:0; background:color-mix(in srgb, var(--bg) 92%, transparent); border-top:1px solid var(--border);">
    <div class="container" style="display:flex; gap:8px;">
      <button class="button" style="flex:1;" onclick="Budget.focusQuickAdd()">＋ Quick Add</button>
      <button class="button ghost" style="flex:1;" onclick="IO.copyData()">Share</button>
    </div>
  </footer>

  <!-- ==================== APP SCRIPT ==================== -->
  <script>
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // ---------- App State ----------
  const App = {
    key: 'nalcap_budget_v2',
    state: null,
    defaultState(){
      const now = new Date();
      const ym = Util.fmtYM(now);
      return {
        settings: { stipendEUR: 1000, currency: 'EUR', fx: 1.08, startMonth: ym },
        bins: [
          { id: Util.id(), name: 'Rent', monthlyEUR: 500 },
          { id: Util.id(), name: 'Groceries', monthlyEUR: 200 },
          { id: Util.id(), name: 'Transport', monthlyEUR: 80 },
        ],
        expenses: { } // { 'YYYY-MM': [ {id, date, binId, name, amountEUR} ] }
      };
    },
    load(){
      try { const raw = localStorage.getItem(this.key); this.state = raw ? JSON.parse(raw) : this.defaultState(); }
      catch { this.state = this.defaultState(); }
    },
    save(){ localStorage.setItem(this.key, JSON.stringify(this.state)); },
    resetAll(){ if(!confirm('Reset all data?')) return; localStorage.removeItem(this.key); location.reload(); }
  };

  // ---------- Utilities ----------
  const Util = {
    id: () => Math.random().toString(36).slice(2,9),
    fmtYM: (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,
    labelYM(ym){ const [y,m]=ym.split('-').map(Number); return new Date(y, m-1, 1).toLocaleString(undefined,{month:'long', year:'numeric'}); },
    ensureMonth(ym){ const S=App.state; if(!S.expenses[ym]) S.expenses[ym]=[]; },
    eurToDisp(eur){ const {currency,fx} = App.state.settings; return currency==='EUR'? eur : eur*fx; },
    dispToEur(n){ const {currency,fx} = App.state.settings; return currency==='EUR'? n : n/fx; },
    money(n){ const cur=App.state.settings.currency==='EUR'?'EUR':'USD'; return new Intl.NumberFormat(undefined,{style:'currency',currency:cur, maximumFractionDigits:2}).format(n); },
  };

  // ---------- Tabs & Rendering ----------
  const UI = {
    currentYM: null,
    switchTab(name){
      const budget = $('#view-budget');
      const profile = $('#view-profile');
      const tb = $('#tab-budget');
      const tp = $('#tab-profile');
      const isBudget = name==='budget';
      budget.hidden = !isBudget; profile.hidden = isBudget;
      tb.setAttribute('aria-selected', isBudget); tp.setAttribute('aria-selected', !isBudget);
      if(isBudget) Budget.render(); else Profile.render();
    }
  };

  // ---------- Profile Logic ----------
  const Profile = {
    render(){
      const S = App.state;
      $('#stipend').value = S.settings.stipendEUR;
      $('#currency').value = S.settings.currency;
      $('#fx').value = S.settings.fx;
      $('#startMonth').value = S.settings.startMonth;
      this.renderBins();
      this.renderOverall();
    },
    save(){
      const S = App.state;
      S.settings.stipendEUR = parseFloat($('#stipend').value||'1000');
      S.settings.currency  = $('#currency').value;
      S.settings.fx        = parseFloat($('#fx').value||'1.08');
      S.settings.startMonth= $('#startMonth').value || Util.fmtYM(new Date());
      App.save();
      $('#saveNote').textContent = 'Saved ✓'; setTimeout(()=>$('#saveNote').textContent=' ', 1200);
      Budget.render(); this.renderBins(); this.renderOverall();
    },
    renderBins(){
      const host = $('#binList'); host.innerHTML='';
      App.state.bins.forEach(b=>{
        const card = document.createElement('div'); card.className='card item';
        card.innerHTML = `
          <div class="logo"></div>
          <div style="flex:1">
            <div style="display:grid; grid-template-columns: 1fr 140px auto; gap:8px; align-items:center;">
              <input data-k="name" data-id="${b.id}" type="text" value="${b.name}" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
              <input data-k="amount" data-id="${b.id}" type="number" inputmode="decimal" step="0.01" value="${b.monthlyEUR}" style="padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card);" />
              <div style="display:flex; gap:6px;">
                <button class="button ghost" onclick="Profile.dupBin('${b.id}')">Duplicate</button>
                <button class="button ghost" onclick="Profile.delBin('${b.id}')">Delete</button>
              </div>
            </div>
            <div class="meta">EUR/mo</div>
          </div>`;
        host.appendChild(card);
      });
      $$('#binList input[data-k]').forEach(inp=>{
        inp.addEventListener('change', (e)=>{
          const id = e.target.dataset.id; const k = e.target.dataset.k; const bin = App.state.bins.find(x=>x.id===id); if(!bin) return;
          if(k==='name') bin.name=e.target.value; else bin.monthlyEUR=parseFloat(e.target.value||'0');
          App.save(); Budget.render(); Profile.renderOverall();
        });
      });
    },
    addBin(){
      const name = $('#newBinName').value.trim(); const amt = parseFloat($('#newBinAmt').value||'0');
      if(!name) return alert('Enter a bin name');
      App.state.bins.push({id:Util.id(), name, monthlyEUR:amt});
      $('#newBinName').value=''; $('#newBinAmt').value='';
      App.save(); this.renderBins(); Budget.render(); this.renderOverall();
    },
    delBin(id){ if(!confirm('Delete this bin?')) return; App.state.bins = App.state.bins.filter(b=>b.id!==id); App.save(); this.renderBins(); Budget.render(); this.renderOverall(); },
    dupBin(id){ const b=App.state.bins.find(x=>x.id===id); if(!b) return; App.state.bins.push({id:Util.id(), name:b.name+' (copy)', monthlyEUR:b.monthlyEUR}); App.save(); this.renderBins(); },
    renderOverall(){
      const host = $('#overallStats'); host.innerHTML='';
      const totalBudgetEUR = App.state.bins.reduce((s,b)=>s+b.monthlyEUR,0);
      let totalSpentEUR=0; Object.values(App.state.expenses).forEach(list=> list.forEach(e=> totalSpentEUR+=e.amountEUR));
      const totalMonths = Object.keys(App.state.expenses).length;
      const makeStat = (label,val) => `<div class="card" style="padding:16px;"><div class="meta">${label}</div><div style="font-size:20px; font-weight:700;">${val}</div></div>`;
      host.innerHTML = [
        makeStat('Monthly Budget', Util.money(Util.eurToDisp(totalBudgetEUR))),
        makeStat('Total Spent (all time)', Util.money(Util.eurToDisp(totalSpentEUR))),
        makeStat('Active Months', totalMonths)
      ].join('');
    }
  };

  // ---------- Budget Logic ----------
  const Budget = {
    shiftMonth(delta){
      const [y,m] = UI.currentYM.split('-').map(Number);
      const d = new Date(y, m-1+delta, 1);
      UI.currentYM = Util.fmtYM(d);
      this.render();
    },
    focusQuickAdd(){ $('#qaName').focus(); },
    clearQuickAdd(){ $('#qaName').value=''; $('#qaAmt').value=''; },
    saveQuickAdd(){
      Util.ensureMonth(UI.currentYM);
      const binId = $('#qaBin').value;
      const name  = $('#qaName').value.trim();
      const date  = $('#qaDate').value || new Date().toISOString().slice(0,10);
      const amtDisp = parseFloat($('#qaAmt').value||'0');
      const amountEUR = Util.dispToEur(amtDisp);
      App.state.expenses[UI.currentYM].push({id:Util.id(), date, binId, name, amountEUR});
      App.save(); this.clearQuickAdd(); this.render(); Profile.renderOverall();
    },
    editExpense(expId){
      const arr = App.state.expenses[UI.currentYM]; const i = arr.findIndex(e=>e.id===expId); if(i<0) return;
      const e = arr[i];
      const newName = prompt('Name', e.name||''); if(newName===null) return; e.name=newName;
      const newAmt  = prompt('Amount ('+(App.state.settings.currency==='EUR'?'€':'$')+')', Util.eurToDisp(e.amountEUR).toFixed(2)); if(newAmt===null) return; e.amountEUR = Util.dispToEur(parseFloat(newAmt||'0'));
      const newDate = prompt('Date (YYYY-MM-DD)', e.date); if(newDate===null) return; e.date = newDate;
      const binNames = App.state.bins.map(b=>b.name).join(', ');
      const newBinName = prompt('Bin name ('+binNames+')', (App.state.bins.find(b=>b.id===e.binId)||{}).name||'');
      if(newBinName!==null){ const b=App.state.bins.find(x=>x.name===newBinName); if(b) e.binId=b.id; }
      App.save(); this.render(); Profile.renderOverall();
    },
    delExpense(expId){ if(!confirm('Delete expense?')) return; const arr=App.state.expenses[UI.currentYM]; const i=arr.findIndex(e=>e.id===expId); if(i>=0){ arr.splice(i,1); App.save(); this.render(); Profile.renderOverall(); } },
    render(){
      const S = App.state;
      if(!UI.currentYM) UI.currentYM = S.settings.startMonth || Util.fmtYM(new Date());
      Util.ensureMonth(UI.currentYM);
      $('#monthLabel').textContent = Util.labelYM(UI.currentYM);

      // Fill quick add defaults
      const now = new Date(); const prefDate = new Date(parseInt(UI.currentYM.slice(0,4)), parseInt(UI.currentYM.slice(5))-1, Math.min(28, now.getDate()));
      $('#qaDate').value = prefDate.toISOString().slice(0,10);
      const sel = $('#qaBin'); sel.innerHTML=''; S.bins.forEach(b=>{ const o=document.createElement('option'); o.value=b.id; o.textContent=b.name; sel.appendChild(o); });
      $('#qaCurLbl').textContent = S.settings.currency==='EUR' ? '€' : '$';

      // Summaries
      const totals = {}; S.bins.forEach(b=>totals[b.id]=0);
      App.state.expenses[UI.currentYM].forEach(e=>{ totals[e.binId]=(totals[e.binId]||0)+e.amountEUR; });
      const host = $('#binsSummary'); host.innerHTML='';
      S.bins.forEach(b=>{
        const spent = totals[b.id]||0; const rem = b.monthlyEUR - spent; const pct = Math.min(100, Math.max(0, (spent/b.monthlyEUR)*100 || 0));
        const bar = `<div style=\"height:10px; background:var(--accent-2); border-radius:999px; overflow:hidden;\"><div style=\"height:100%; width:${pct}%; background:var(--accent);\"></div></div>`;
        const card = document.createElement('div'); card.className='card'; card.style.padding='14px';
        card.innerHTML = `
          <div class="item" style="padding:0; gap:10px;">
            <div class="logo"></div>
            <div style="flex:1">
              <h3 style="margin:0 0 6px;">${b.name}</h3>
              ${bar}
              <div class="meta" style="display:flex; gap:8px; margin-top:6px;">
                <span class="badge">Budget ${Util.money(Util.eurToDisp(b.monthlyEUR))}</span>
                <span class="badge" style="border-style:${rem<0?'solid':'dashed'}; color:${rem<0?'#b00020':'var(--muted)'};">Rem ${Util.money(Util.eurToDisp(rem))}</span>
              </div>
            </div>
          </div>`;
        host.appendChild(card);
      });

      // Expenses
      const list = $('#expenseList'); list.innerHTML='';
      const items = App.state.expenses[UI.currentYM];
      $('#noExpenses').style.display = items.length? 'none' : 'block';
      items.slice().reverse().forEach(e=>{
        const bin = S.bins.find(b=>b.id===e.binId);
        const row = document.createElement('div'); row.className='card item';
        row.innerHTML = `
          <div class="logo"></div>
          <div style="flex:1">
            <h3>${e.name||'(untitled)'}</h3>
            <div class="meta">${new Date(e.date).toLocaleDateString()} · ${bin?bin.name:'(bin deleted)'}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${Util.money(Util.eurToDisp(e.amountEUR))}</div>
            <div class="meta"><a href="#" onclick="Budget.editExpense('${e.id}'); return false;">Edit</a> · <a href="#" onclick="Budget.delExpense('${e.id}'); return false;">Delete</a></div>
          </div>`;
        list.appendChild(row);
      });
    }
  };

  // ---------- Import / Export ----------
  const IO = {
    lastSheetRows: [],
    header: [],
    exportCSV(){
      const rows = [['ym','date','bin','name','amount','currency']];
      for(const [ym, list] of Object.entries(App.state.expenses)){
        list.forEach(e=>{ const bin=App.state.bins.find(b=>b.id===e.binId); rows.push([ym, e.date, bin?bin.name:'', e.name||'', Util.eurToDisp(e.amountEUR).toFixed(2), App.state.settings.currency]); });
      }
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      IO._download('nalcap-budget.csv','text/csv',csv);
    },
    exportJSON(){ IO._download('nalcap-budget.json','application/json', JSON.stringify(App.state,null,2)); },
    _download(name,type,data){ const blob = new Blob([data],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); },
    copyData(){ navigator.clipboard?.writeText(JSON.stringify(App.state,null,2)).then(()=>alert('Data copied to clipboard')).catch(()=>alert('Copy failed')); },

    openMapper(){ const m=$('#mapper'); if(!IO.lastSheetRows.length){ alert('Choose an Excel/CSV file first.'); return; } m.style.display='block'; },
    fillMapper(){ const selects=['map-date','map-bin','map-name','map-amount','map-currency'].map(id=>$('#'+id)); selects.forEach(s=>{ s.innerHTML=''; IO.header.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h; s.appendChild(o); });});
      // try auto map by common names
      const map = {date:['date','fecha'], bin:['bin','category','categoria'], name:['name','description','desc'], amount:['amount','importe','monto','value'], currency:['currency','divisa']};
      for(const [id,keys] of Object.entries(map)){ const sel=$('#map-'+id); const guess = IO.header.find(h=> keys.includes(h.toLowerCase())); if(guess) sel.value=guess; }
    },
    applyMapping(){
      const col = k=>$('#map-'+k).value;
      const rows = IO.lastSheetRows.map(r=>({
        date: r[col('date')] || '',
        bin: r[col('bin')] || 'Misc',
        name: r[col('name')] || '',
        amount: parseFloat(r[col('amount')]||'0'),
        currency: (r[col('currency')]||'EUR').toString().toUpperCase()
      }));
      rows.forEach(o=>{
        const ym = o.date? o.date.slice(0,7) : Util.fmtYM(new Date());
        Util.ensureMonth(ym);
        const bin = IO.ensureBin(o.bin);
        const amountEUR = o.currency==='USD' ? o.amount / App.state.settings.fx : o.amount;
        App.state.expenses[ym].push({id:Util.id(), date:o.date||ym+'-15', binId:bin.id, name:o.name, amountEUR});
      });
      App.save(); Budget.render(); Profile.renderOverall(); alert('Import complete');
    },
    ensureBin(name){ let b=App.state.bins.find(x=>x.name===name); if(!b){ b={id:Util.id(), name, monthlyEUR:0}; App.state.bins.push(b);} return b; }
  };

  // File input handler (CSV / XLSX)
  $('#fileInput').addEventListener('change', async (ev)=>{
    const file = ev.target.files[0]; if(!file) return;
    const name = file.name.toLowerCase();
    if(name.endsWith('.csv')){
      const text = await file.text();
      const rows = text.split(/\r?\n/).filter(Boolean).map(line => line.match(/(?:\"([^\"]*)\")|([^,]+)/g)?.map(x=>x?.replace(/^\"|\"$/g,'').replace(/\"\"/g,'"')) || []);
      IO.header = rows.shift();
      IO.lastSheetRows = rows.map(r=> Object.fromEntries(IO.header.map((h,i)=>[h,r[i]])) );
      IO.fillMapper(); IO.openMapper();
    } else {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {defval:'', header:1});
      IO.header = (json.shift()||[]).map(h=> String(h||''));
      IO.lastSheetRows = json.map(r=> Object.fromEntries(IO.header.map((h,i)=>[h, r[i]])) );
      IO.fillMapper(); IO.openMapper();
    }
  });

  // ---------- Init ----------
  App.load();
  UI.switchTab('budget');
  </script>
</body>
</html>